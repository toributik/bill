<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Billing App</title>
  <link rel="icon" type="image/png" href="img/logotab.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bg.css" rel="stylesheet">
  <!-- Add this with your other script includes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <!-- Font Awesome for the logout icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
      @media (max-width: 768px) { /* Targets mobile screens */
    .table-dark th, .table-dark td {
      font-size: 12px; /* Reduce font size */
      padding: 2px; /* Reduce padding */
    }
    
    .table {
      font-size: 10px; /* Reduce overall table font size */
    }
  
    .btn-sm {
      padding: 4px 8px; /* Adjust button size */
      font-size: 10px;
    }
  }

  .logo {
        width: 45px; /* Adjust size as needed */
        height: 40px;
        transition: transform 0.3s ease-in-out; /* Smooth animation */
        }

        .logo:hover {
            transform: rotate(360deg) scale(1.1); /* Spins and slightly enlarges on hover */
        }

        .hide-auth {
  display: none !important;
    }    

/*
#barcodeInput {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
}

#barcodeInput.d-none {
  display: none;
}
} */
  </style>
</head>
<body>
  <div>
    <div class="particles" id="particles"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>
  <!-- Image and text -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center text-light" href="#">
        <img src="img/sumadhu.png" alt="Logo" class="logo me-3" style="margin-right: 10px;">
        <strong> Billing System</strong>
    </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item">
            <a class="btn btn1 btn-sm mr-2 mb-1" href="till-now.html">View All Bills</a>
          </li>
          
          <div id="main-content" class="hide-auth">
            <li class="nav-item">
              <a class="btn btn1 btn-sm mr-2 mb-1" href="product.html">Products Management</a>
            </li>
        </div>
          <li class="nav-item">
            <button class="btn btn-danger btn-sm mb-1" onclick="logout()" title="Logout">
              <i class="fas fa-sign-out-alt"></i> LogOut
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div id="productMessage">
    <p class="indi"> <i class="fa-solid fa-circle-check"></i> Success</p>
  </div>
  <div class="container mt-5" style="padding-top: 35px;">
    <!-- Customer Details -->
    <div class="row mb-2">
      <div class="col-md-2">
        <!-- Customer Name Input with Suggestions -->
      <input type="text" id="customerName" class="form-control from-input  form-control from-input-sm mb-1" placeholder="Customer Name" list="customerList" oninput="fillCustomerMobile()" onchange="fillCustomerMobile()" autocomplete="off">
      <datalist id="customerList"></datalist>
      </div>
      <div class="col-md-2">
        <input type="tel" id="customerMobile" class="form-control from-input form-control from-input-sm mb-1" placeholder="Mobile Number" autocomplete="off">
      </div>
      <div class="col-md-2">
        <div class="input-group">
          <!-- <div class="input-group-prepend">
            <span class="form-control  form-control from-input-sm mb-1">Bill ID</span>
          </div> -->
          <input type="text" id="billId" class="form-control from-input form-control from-input-sm mb-1" readonly>
        </div>
      </div>
      <!-- Add this after the customerMobile input field -->
      <div class="col-md-2">
        <input type="date" id="billDate" class="form-control from-input form-control from-input-sm mb-1">
      </div>
      <div class="col-md-2">
        <input type="time" id="billTime" class="form-control from-input form-control from-input-sm mb-1">
      </div>
      <!-- Add this in your product selection row, just before the product select -->
      <div class="col-md-2">
        <button class="btn btn-info w-100 mb-1" onclick="startBarcodeScan()">
          <i class="fas fa-barcode"></i> Scan Barcode
        </button>
        <input type="text" id="barcodeInput" class="form-control from-input form-control from-input-sm d-none" 
              placeholder="Scan barcode" autocomplete="off">
      </div>
    </div>

    <!-- Product Selection & Input Fields -->
    <div class="row mb-3">
      <div class="col-md-4">
        <select id="productSelect" class="selectpicker form-control from-input-sm  mb-1" onchange="updatePrice()" data-live-search="true">
          <option value="">Select Product</option>
        </select>
      </div>
      <div class="col-md-2">
        <!-- <input type="number" id="price" class="form-control from-input" placeholder="Price" readonly> -->
        <input type="number" id="price" class="form-control from-input form-control from-input-sm mb-1" placeholder="Price" >
      </div>
      <div class="col-md-2">
        <input type="number" id="quantity" class="form-control from-input form-control from-input-sm mb-1" placeholder="Quantity">
      </div>
       <!-- Add this after the billTime input field -->
       <div class="col-md-2">
        <select id="remarks" class="form-control from-input form-control from-input-sm mb-1" onchange="handleRemarksChange()">
          <option value="">Payment Method</option>
          <option value="UPI">UPI</option>
          <option value="Cash">Cash</option>
          <option value="DUE">DUE</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <button class="btn btn2 w-100" onclick="addItem()">  <i class="fas fa-plus-circle"></i>Add Item</button>
      </div>
      <div class="col-md-2">
        <select id="billType" class="form-control from-input form-control from-input-sm mb-1 d-none">
          <option value="bill.html" >Detailed Bill</option>
          <option value="slip-bill.html" selected>Slip Bill</option>
        </select>
      </div>
    </div>
    
    <!-- Items Table -->
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>#</th> <!-- Add this for serial number -->
          <th>Products</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="billTable"></tbody>
    </table>

    <!-- Total & Discount Section -->
    <div class="row justify-content-end">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body p-1">  <!-- Reduced padding -->
              <div class="form-group d-flex align-items-center justify-content-between">  <!-- Reduced margin -->
                <label for="subTotal" class="" style="min-width: 100px;">Sub Total:</label>  <!-- Removed label margin -->
                <input type="number" id="subTotal" class="form-control from-input form-control from-input-sm" readonly value="0">  <!-- Smaller input -->
              </div>
              <div class="form-group d-flex align-items-center justify-content-between">
                <label for="discount" class="mb-0" style="min-width: 100px;">Discount %:</label>
                <input type="number" id="discount" value="0" class="form-control from-input form-control from-input-sm" placeholder="0" oninput="applyDiscount()">
              </div>
              <hr>
              <div class="form-group form-check mb-2">
                <input type="checkbox" class="form-check-input" id="enableGST" onchange="applyGST()">
                <label class="form-check-label" for="enableGST">GST (18%)</label>  <!-- Shortened label -->
              </div>
              <div class="form-group d-flex align-items-center justify-content-between mb-2">
                <label class="mb-0" style="min-width: 100px;">GST Amt:</label>  <!-- Shortened label -->
                <input type="number" id="gstAmount" class="form-control from-input form-control from-input-sm" readonly value="0">
              </div>
              <div class="form-group d-flex align-items-center justify-content-between mb-2">  <!-- Smallest margin -->
                <label for="grandTotal" class="mb-0" style="min-width: 100px;">Grand Total:</label>
                <input type="number" id="grandTotal" class="form-control from-input form-control from-input-sm font-weight-bold" readonly value="0">  <!-- Bold for emphasis -->
              </div>
              
            </div>
          </div>
        </div>
      </div>

    <!-- Generate Bill Button -->
    <div class="text-center mt-2">
      <button class="btn btn1 w-100 mb-1" onclick="generateBill()" style="height: 60px; font-size: 1.20rem;">
        <i class="fas fa-bolt"></i> <span>Generate Bill</span>   
      </button>
      
    <!-- Add this above the Generate Bill button -->
<div class="row mb-3">
  <div class="col-md-12">
    
  </div>
</div>
    </div>
  </div>
<!-- Due Amount Modal -->
<div class="modal fade" id="dueAmountModal" tabindex="-1" role="dialog" aria-labelledby="dueAmountModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dueAmountModalLabel">Enter Due Amount</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="dueAmount">Due Amount:</label>
          <input type="number" class="form-control" id="dueAmount" placeholder="Enter due amount">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveDueAmount()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Other Remarks Modal -->
<div class="modal fade" id="otherRemarksModal" tabindex="-1" role="dialog" aria-labelledby="otherRemarksModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="otherRemarksModalLabel">Enter Remarks</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="customRemarks">Remarks:</label>
          <input type="text" class="form-control" id="customRemarks" placeholder="Enter your remarks">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveOtherRemarks()">Save</button>
      </div>
    </div>
  </div>
</div>
  <!-- Scripts -->
  <script src="css/all.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

  <script>
  
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();


    let productData = [];
    let grandTotal = 0;

    // Fetch product data from JSON file
    function fetchProducts() {
      database.ref("products").on("value", snapshot => {
        let productSelect = document.getElementById("productSelect");
        productSelect.innerHTML = '<option value="">Select Product</option>';
        snapshot.forEach(childSnapshot => {
          let product = childSnapshot.val();
          let option = document.createElement("option");
          option.value = product.price;
          option.textContent = product.name;
          productSelect.appendChild(option);
        });
        $('.selectpicker').selectpicker('refresh');
      });
    }

    function updatePrice() {
      let productSelect = document.getElementById("productSelect");
      let priceInput = document.getElementById("price");
      priceInput.value = productSelect.value ? productSelect.value : "";
    }

    function addItem() {
  let productSelect = document.getElementById("productSelect");
  let price = parseFloat(document.getElementById("price").value);
  let quantity = parseInt(document.getElementById("quantity").value);
  let productName = productSelect.options[productSelect.selectedIndex].text;

  if (!productName || isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
    //alert("Please select a valid product and enter quantity.");
    showMessage('Please select a valid product and enter quantity.');
    return;
  }

  let total = price * quantity;
  grandTotal += total;

  let table = document.getElementById("billTable");
  let rowCount = table.rows.length; // Get current row count for serial number
  let row = table.insertRow();
  row.innerHTML = `
    <td>${rowCount + 1}</td> <!-- Serial number -->
    <td>${productName}</td>
    <td>₹${price.toFixed(2)}</td>
    <td>${quantity}</td>
    <td>₹${total.toFixed(2)}</td>
    <td class="text-center align-middle"><button class="btn btn-danger btn-sm" onclick="removeItem(this, ${total})"><i class="fas fa-trash"></i></button></td>
  `;

  updateTotals();
  document.getElementById("quantity").value = "";
}

function removeItem(button, itemTotal) {
  let row = button.parentElement.parentElement;
  let table = row.parentElement;
  row.remove();
  grandTotal -= itemTotal;
  
  // Renumber all remaining rows
  let rows = table.rows;
  for (let i = 0; i < rows.length; i++) {
    rows[i].cells[0].textContent = i + 1; // Update serial number
  }
  
  updateTotals();
}

    function updateTotals() {
      document.getElementById("subTotal").value = grandTotal.toFixed(2);
      applyDiscount();
      applyGST();
    }

    function applyDiscount() {
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      const subTotal = parseFloat(document.getElementById("subTotal").value) || 0;
      
      if (discount < 0 || discount > 100) {
        alert("Discount must be between 0% and 100%");
        document.getElementById("discount").value = "";
        return;
      }

      applyGST();
    }

    function applyGST() {
      const gstEnabled = document.getElementById("enableGST").checked;
      const subTotal = parseFloat(document.getElementById("subTotal").value) || 0;
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      
      let discountedAmount = subTotal;
      if (discount > 0) {
        discountedAmount = subTotal - (subTotal * discount / 100);
      }

      if (gstEnabled) {
        const gstAmount = discountedAmount * 0.18;
        document.getElementById("gstAmount").value = gstAmount.toFixed(2);
        document.getElementById("grandTotal").value = (discountedAmount + gstAmount).toFixed(2);
      } else {
        document.getElementById("gstAmount").value = "0";
        document.getElementById("grandTotal").value = discountedAmount.toFixed(2);
      }
    }

// Add this function to generate the next Bill ID
// async function getNextBillId() {
//   try {
//     const snapshot = await database.ref("bills").orderByKey().limitToLast(1).once("value");
//     let lastBillId = "BTB0"; // Default starting point
    
//     if (snapshot.exists()) {
//       const lastBillKey = Object.keys(snapshot.val())[0];
//       const lastBillData = snapshot.val()[lastBillKey];
      
//       if (lastBillData.billId) {
//         lastBillId = lastBillData.billId;
//       }
//     }
    
//     // Extract the number part and increment
//     const lastNumber = parseInt(lastBillId.replace("BTB", "")) || 0;
//     return `BTB${lastNumber + 1}`;
//   } catch (error) {
//     console.error("Error fetching last bill ID:", error);
//     return "BTB1"; // Fallback if there's an error
//   }
// }

async function getNextBillId() {
  try {
    // Get current date components
    const now = new Date();
    const currentYear = now.getFullYear().toString().slice(-2);
    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                        'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
    const currentMonth = monthNames[now.getMonth()];
    
    // Format: B25APRTB1 (Year + Month, sequence continues in same month)
    const prefix = `B${currentYear}${currentMonth}TB`;
    
    const snapshot = await database.ref("bills")
      .orderByChild("billId")
      .startAt(prefix)
      .endAt(prefix + "\uf8ff")
      .limitToLast(1)
      .once("value");
    
    let lastNumber = 0; // Default starting point if no bills exist this month
    
    if (snapshot.exists()) {
      const lastBill = Object.values(snapshot.val())[0];
      if (lastBill.billId && lastBill.billId.startsWith(prefix)) {
        // Extract the number part after the prefix
        const numberPart = lastBill.billId.replace(prefix, "");
        lastNumber = parseInt(numberPart) || 0;
      }
    }
    
    return `${prefix}${lastNumber + 1}`;
  } catch (error) {
    console.error("Error fetching last bill ID:", error);
    // Fallback with sequence 1 if there's an error
    const now = new Date();
    const currentYear = now.getFullYear().toString().slice(-2);
    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                        'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
    const currentMonth = monthNames[now.getMonth()];
    
    return `B${currentYear}${currentMonth}TB1`;
  }
}

// Modify your generateBill function to include the billId
async function generateBill() {
  // Check if there are any items in the bill table
  const billTable = document.getElementById("billTable");
  if (billTable.rows.length === 0) {
    showMessage('Please add at least one item before generating the bill.');
    return;
  }

  // Get the selected bill type
  const billType = document.getElementById("billType").value;

  // Disable the button to prevent multiple clicks
  const generateBtn = document.querySelector('button[onclick="generateBill()"]');
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

  // Get the next bill ID
  const billId = await getNextBillId();
  document.getElementById("billId").value = billId;

  const customerName = document.getElementById("customerName").value || "Walk-in Customer";
  const customerMobile = document.getElementById("customerMobile").value || "";
  const subTotal = document.getElementById("subTotal").value;
  const discount = document.getElementById("discount").value;
  const gstAmount = document.getElementById("gstAmount").value;
  const grandTotal = document.getElementById("grandTotal").value;
  const remarks = document.getElementById("remarks").value || "";

  let formattedRemarks = "";
  if (remarksData.type === "DUE" && remarksData.dueAmount) {
    formattedRemarks = `Due: ${remarksData.dueAmount}`;
  } else if (remarksData.type === "Other" && remarksData.customRemarks) {
    formattedRemarks = remarksData.customRemarks;
  } else {
    formattedRemarks = remarksData.type;
  }

  const items = Array.from(document.querySelectorAll("#billTable tr")).map(row => {
    let cells = row.getElementsByTagName("td");
    if (cells.length === 6) {
      return {
        name: cells[1].textContent.trim(),
        price: parseFloat(cells[2].textContent.replace("₹", "").trim()) || 0,
        quantity: parseInt(cells[3].textContent.trim()) || 0,
        total: parseFloat(cells[4].textContent.replace("₹", "").trim()) || 0
      };
    }
  }).filter(item => item && item.name);

  const billData = {
    billId: billId,
    customer: { name: customerName, mobile: customerMobile },
    items,
    subTotal,
    discount,
    gstAmount,
    grandTotal,
    remarks: formattedRemarks,
    date: combineDateTime(
      document.getElementById("billDate").value,
      document.getElementById("billTime").value
    ) || new Date().toISOString()
  };

  // Save to database
  const newBillRef = database.ref("bills").push();
  
  // First save the bill
  newBillRef.set(billData)
    .then(() => {
      // After saving the bill, update stock quantities
      return updateStockQuantities(items);
    })
    .then(() => {
      localStorage.setItem("currentBillData", JSON.stringify(billData));
      window.location.href = billType;
    })
    .catch((error) => {
      console.error("Error saving bill:", error);
      showMessage("Error generating bill. Please try again.");
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-bolt"></i> <span>Generate Bill</span>';
    });
}

// Function to update stock quantities in Firebase
async function updateStockQuantities(items) {
  // Get all products from Firebase
  const snapshot = await database.ref("products").once("value");
  const products = snapshot.val();
  
  // Create an object to store all updates
  const updates = {};
  
  // Process each item in the bill
  for (const item of items) {
    // Find the product in our products list
    for (const productId in products) {
      const product = products[productId];
      if (product.name === item.name) {
        // Only update if stockQuantity exists and is greater than 0
        if (product.stockQuantity && product.stockQuantity > 0) {
          const newQuantity = product.stockQuantity - item.quantity;
          updates[`products/${productId}/stockQuantity`] = Math.max(0, newQuantity);
        }
        break; // Move to next item once we find the product
      }
    }
  }
  
  // If we have updates, apply them
  if (Object.keys(updates).length > 0) {
    return database.ref().update(updates);
  }
  
  return Promise.resolve();
}

// Function to find product by name (used in other parts of the code)
async function findProductByName(productName) {
  const snapshot = await database.ref("products").orderByChild("name").equalTo(productName).once("value");
  if (snapshot.exists()) {
    const products = snapshot.val();
    // Return the first product found (should be unique if names are unique)
    return products[Object.keys(products)[0]];
  }
  return null;
}

function combineDateTime(dateString, timeString) {
  if (!dateString) return null;
  
  // If no time is provided, default to current time
  if (!timeString) {
    timeString = new Date().toTimeString().substring(0, 5);
  }
  
  // Combine date and time into ISO format
  const dateTimeString = `${dateString}T${timeString}:00`;
  const dateTime = new Date(dateTimeString);
  
  // Return as ISO string (includes timezone offset)
  return dateTime.toISOString();
}

// Call this when the page loads to display the next bill ID
document.addEventListener('DOMContentLoaded', async function() {
  const nextBillId = await getNextBillId();
  document.getElementById("billId").value = nextBillId;

   // Set default date and time to now
  const now = new Date();
  document.getElementById("billDate").value = now.toISOString().split('T')[0];
  document.getElementById("billTime").value = now.toTimeString().substring(0, 5);
  
  // Rest of your existing DOMContentLoaded code...
  fetchProducts();
  fetchCustomers();
});

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }
   
//    auth.onAuthStateChanged(user => {
 // if (!user) {
 //   window.location.href = "login.html"; // Redirect to login if not authenticated
//  }
//});

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html"; // Redirect if not logged in
  } else {
    const mainContent = document.getElementById('main-content');
    
    // Check if user is toributik33@gmail.com
    if (user.email === "toributik33@gmail.com") {
      mainContent.classList.remove('hide-auth'); // Show content
    } else {
      mainContent.classList.add('hide-auth'); // Hide content

    }
  }
});


    fetchProducts();


//     function fetchCustomers() {
//     database.ref("bills").on("value", (snapshot) => {
//         let customers = {};
//         snapshot.forEach((childSnapshot) => {
//             let bill = childSnapshot.val();
//             if (bill.customer && bill.customer.name) {
//                 customers[bill.customer.name] = bill.customer.mobile; // Store name & mobile
//             }
//         });

//         let datalist = document.getElementById("customerList");
//         datalist.innerHTML = ""; // Clear previous suggestions
//         for (let name in customers) {
//             let option = document.createElement("option");
//             option.value = name;
//             option.dataset.mobile = customers[name]; // Store mobile in dataset
//             datalist.appendChild(option);
//         }
//     });
// }

function fetchCustomers() {
    database.ref("bills").on("value", (snapshot) => {
        let nameToMobile = {};
        let mobileToName = {};
        snapshot.forEach((childSnapshot) => {
            let bill = childSnapshot.val();
            if (bill.customer && bill.customer.name && bill.customer.mobile) {
                nameToMobile[bill.customer.name] = bill.customer.mobile;
                mobileToName[bill.customer.mobile] = bill.customer.name;
            }
        });

        // Store these mappings in the window object for easy access
        window.customerData = {
            nameToMobile: nameToMobile,
            mobileToName: mobileToName
        };

        // Update the datalist for name suggestions
        let datalist = document.getElementById("customerList");
        datalist.innerHTML = "";
        for (let name in nameToMobile) {
            let option = document.createElement("option");
            option.value = name;
            option.dataset.mobile = nameToMobile[name];
            datalist.appendChild(option);
        }
    });
}

// function fillCustomerMobile() {
//     let customerName = document.getElementById("customerName").value;
//     let options = document.querySelectorAll("#customerList option");

//     for (let option of options) {
//         if (option.value === customerName) {
//             document.getElementById("customerMobile").value = option.dataset.mobile;
//             return;
//         }
//     }
// }

// document.getElementById("customerMobile").addEventListener("input", function() {
//     let mobile = this.value.trim();
//     if (window.customerData && window.customerData.mobileToName[mobile]) {
//         document.getElementById("customerName").value = window.customerData.mobileToName[mobile];
//     }
// });

function fillCustomerMobile() {
    let customerName = document.getElementById("customerName").value;
    let options = document.querySelectorAll("#customerList option");

    for (let option of options) {
        if (option.value === customerName) {
            document.getElementById("customerMobile").value = option.dataset.mobile;
            return;
        }
    }
}

// Fetch customers on page load
fetchCustomers();


// Update your showSuccessMessage function to accept a custom message
function showMessage(message = "sdsf ") {
      const messageDiv = document.getElementById("productMessage");
      messageDiv.innerHTML = `<p class="indi"><i class="fa-solid fa-xmark"></i> ${message}</p>`;
      messageDiv.style.display = "block";
      
      // Hide the message after 3 seconds
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 4000);
    }



    // Global variables to store remarks data
let remarksData = {
  type: "",
  dueAmount: "",
  customRemarks: ""
};

function handleRemarksChange() {
  const remarksSelect = document.getElementById("remarks");
  const selectedValue = remarksSelect.value;
  
  remarksData.type = selectedValue;
  
  if (selectedValue === "DUE") {
    $('#dueAmountModal').modal('show');
  } else if (selectedValue === "Other") {
    $('#otherRemarksModal').modal('show');
  } else {
    // For UPI and Cash, just use the selected value
    remarksData.dueAmount = "";
    remarksData.customRemarks = "";
  }
}

function saveDueAmount() {
  const dueAmount = document.getElementById("dueAmount").value;
  if (!dueAmount || isNaN(dueAmount) || parseFloat(dueAmount) <= 0) {
    alert("Please enter a valid due amount");
    return;
  }
  
  remarksData.dueAmount = dueAmount;
  $('#dueAmountModal').modal('hide');
  document.getElementById("dueAmount").value = ""; // Clear the input for next time
}

function saveOtherRemarks() {
  const customRemarks = document.getElementById("customRemarks").value;
  if (!customRemarks || customRemarks.trim() === "") {
    alert("Please enter remarks");
    return;
  }
  
  remarksData.customRemarks = customRemarks;
  $('#otherRemarksModal').modal('hide');
  document.getElementById("customRemarks").value = ""; // Clear the input for next time
}


// Global variable to track if we're in barcode scanning mode
let isBarcodeScanning = false;

function startBarcodeScan() {
  isBarcodeScanning = true;
  const scanBtn = document.querySelector('button[onclick="startBarcodeScan()"]');
  scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
  scanBtn.classList.remove('btn-info');
  scanBtn.classList.add('btn-warning');
  
  // Show and focus the hidden barcode input
  const barcodeInput = document.getElementById('barcodeInput');
  barcodeInput.classList.remove('d-none');
  barcodeInput.focus();
  
  // Show message to user
  showMessage('Ready to scan - point barcode scanner at this window');
}

function stopBarcodeScan() {
  isBarcodeScanning = false;
  const scanBtn = document.querySelector('button[onclick="startBarcodeScan()"]');
  scanBtn.innerHTML = '<i class="fas fa-barcode"></i> Scan Barcode';
  scanBtn.classList.remove('btn-warning');
  scanBtn.classList.add('btn-info');
  
  // Hide the barcode input
  document.getElementById('barcodeInput').classList.add('d-none');
}

// Add event listener for barcode input
document.getElementById('barcodeInput').addEventListener('input', function(e) {
  if (!isBarcodeScanning) return;
  
  const barcode = e.target.value.trim();
  if (barcode) {
    // Look up product by barcode
    lookupProductByBarcode(barcode);
  }
  
  // Clear the input for next scan
  e.target.value = '';
});

// Function to lookup product by barcode
function lookupProductByBarcode(barcode) {
  // First check if we have the product data already loaded
  const product = findProductByBarcode(barcode);
  
  if (product) {
    // Product found - auto-fill the form
    autoFillProductForm(product);
    stopBarcodeScan();
  } else {
    // Product not found in local data - try fetching from Firebase
    fetchProductByBarcodeFromFirebase(barcode);
  }
}

// Helper function to find product in local data
function findProductByBarcode(barcode) {
  // This assumes you have a global productData array with all products
  // If not, you'll need to fetch from Firebase
  return productData.find(p => p.barcode === barcode);
}

// Function to fetch product from Firebase by barcode
function fetchProductByBarcodeFromFirebase(barcode) {
  database.ref("products").orderByChild("barcode").equalTo(barcode).once("value")
    .then(snapshot => {
      if (snapshot.exists()) {
        const product = Object.values(snapshot.val())[0];
        autoFillProductForm(product);
        stopBarcodeScan();
      } else {
        showMessage('Product not found for barcode: ' + barcode);
        stopBarcodeScan();
      }
    })
    .catch(error => {
      console.error("Error fetching product:", error);
      showMessage('Error looking up product');
      stopBarcodeScan();
    });
}

// Function to auto-fill the product form
function autoFillProductForm(product) {
  const productSelect = document.getElementById('productSelect');
  
  // Find the option that matches this product
  for (let i = 0; i < productSelect.options.length; i++) {
    if (productSelect.options[i].text === product.name) {
      productSelect.selectedIndex = i;
      $('.selectpicker').selectpicker('refresh');
      break;
    }
  }
  
  // Set the price
  document.getElementById('price').value = product.price;
  
  // Focus on quantity field for quick entry
  document.getElementById('quantity').focus();
  
  showMessage(`Product found: ${product.name}`);
}
  </script>
</body>
</html>
