<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Billing App</title>
  <link rel="icon" type="image/png" href="img/logotab.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bg.css" rel="stylesheet">
  <!-- Add this with your other script includes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <!-- Font Awesome for the logout icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
      @media (max-width: 768px) { /* Targets mobile screens */
    .table-dark th, .table-dark td {
      font-size: 12px; /* Reduce font size */
      padding: 2px; /* Reduce padding */
    }
    
    .table {
      font-size: 10px; /* Reduce overall table font size */
    }
  
    .btn-sm {
      padding: 4px 8px; /* Adjust button size */
      font-size: 10px;
    }
    .fa-plus{
    font-size: 7px;
  }
  .btn-table{
    padding: 2px 2px;
  }
  }

  .btn-table{
    border-radius: 50%;
    font-size: 10px;
  }
  .logo {
        width: 45px; /* Adjust size as needed */
        height: 40px;
        transition: transform 0.3s ease-in-out; /* Smooth animation */
        }

        .logo:hover {
            transform: rotate(360deg) scale(1.1); /* Spins and slightly enlarges on hover */
        }

        .hide-auth {
  display: none !important;
    }    


#barcodeInput {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
}

#barcodeInput.d-none {
  display: none;
}

  </style>
</head>
<body>
  <div>
    <div class="particles" id="particles"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>
  <!-- Image and text -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center text-light" href="#">
        <img src="img/logotab.png" alt="Logo" class="logo me-3" style="margin-right: 10px;">
        <strong> Billing System</strong>
    </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item">
            <a class="btn btn1 btn-sm mr-2 mb-1" href="till-now.html" style="padding: 6px; margin-top: 4px;">View All Bills</a>
          </li>
          
          <span id="main-content" class="hide-auth">
            <div class="dropdown">
              <button class="btn btn1 mr-2 dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Pages
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="product.html">Products Management</a>
                <a class="dropdown-item" href="expense.html">Add Expense</a>
                <a class="dropdown-item" href="report.html">Report</a>
                <a class="dropdown-item" href="trash.html">Trash</a>
              </div>
            </div>
          
          </span>
          <li class="nav-item">
            <button class="btn btn-danger btn-sm mb-1" onclick="logout()" title="Logout">
              <i class="fas fa-sign-out-alt"></i> LogOut
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div id="productMessage">
    <p class="indi"> <i class="fa-solid fa-circle-check"></i> Success</p>
  </div>
  <div class="container mt-5" style="padding-top: 35px;">
    <!-- Customer Details -->
    <div class="row mb-2">
      <div class="col-md-2">
        <!-- Customer Name Input with Suggestions -->
      <input type="text" id="customerName" class="form-control from-input  form-control from-input-sm mb-1 text-capitalize" placeholder="Customer Name" list="customerList" oninput="fillCustomerMobile()" onchange="fillCustomerMobile()" autocomplete="off">
      <datalist id="customerList"></datalist>
      </div>
      <div class="col-md-2">
        <input type="tel" id="customerMobile" class="form-control from-input form-control from-input-sm mb-1" placeholder="Mobile Number" autocomplete="off">
      </div>
      <div class="col-md-2">
        <div class="input-group">
          <!-- <div class="input-group-prepend">
            <span class="form-control  form-control from-input-sm mb-1">Bill ID</span>
          </div> -->
          <input type="text" id="billId" class="form-control from-input form-control from-input-sm mb-1">
        </div>
      </div>
      <!-- Add this after the customerMobile input field -->
      <div class="col-md-2">
        <input type="date" id="billDate" class="form-control from-input form-control from-input-sm mb-1">
      </div>
      <div class="col-md-2">
        <input type="time" id="billTime" class="form-control from-input form-control from-input-sm mb-1">
      </div>
      <!-- Add this in your product selection row, just before the product select -->
      <div class="col-md-2">
        <button class="btn btn-info w-100 mb-1" onclick="startBarcodeScan()">
          <i class="fas fa-barcode"></i> Scan Barcode
        </button>
        <input type="text" id="barcodeInput" class="form-control from-input form-control from-input-sm d-none" 
              placeholder="Scan barcode" autocomplete="off">
      </div>
    </div>

    <!-- Product Selection & Input Fields -->
    <div class="row mb-3">
      <div class="col-md-4">
        <select id="productSelect" class="selectpicker form-control from-input-sm  mb-1" onchange="updatePrice()" data-live-search="true">
          <option value="">Select Product</option>
        </select>
      </div>
      <div class="col-md-2">
        <!-- <input type="number" id="price" class="form-control from-input" placeholder="Price" readonly> -->
        <input type="number" id="price" class="form-control from-input form-control from-input-sm mb-1" placeholder="Price" >
      </div>
      <div class="col-md-2">
        <input type="number" id="quantity" class="form-control from-input form-control from-input-sm mb-1" placeholder="Quantity">
      </div>
       <!-- Add this after the billTime input field -->
       <div class="col-md-2">
        <select id="remarks" class="form-control from-input form-control from-input-sm mb-1" onchange="handleRemarksChange()">
          <option value="">Payment Method</option>
          <option value="UPI">UPI</option>
          <option value="Cash">Cash</option>
          <option value="DUE">DUE</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <button class="btn btn2 w-100" onclick="addItem()">  <i class="fas fa-plus-circle"></i>Add Item</button>
      </div>
      <div class="col-md-2">
        <select id="billType" class="form-control from-input form-control from-input-sm mb-1 d-none">
          <option value="bill.html" >Detailed Bill</option>
          <option value="slip-bill.html" selected>Slip Bill</option>
        </select>
      </div>
    </div>
    
    <!-- Items Table -->
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>#</th> <!-- Add this for serial number -->
          <th>Products</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="billTable"></tbody>
    </table>

    <!-- Total & Discount Section -->
    <div class="row justify-content-end">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body p-1">  <!-- Reduced padding -->
              <div class="form-group d-flex align-items-center justify-content-between">  <!-- Reduced margin -->
                <label for="subTotal" class="" style="min-width: 100px;">Sub Total:</label>  <!-- Removed label margin -->
                <input type="number" id="subTotal" class="form-control from-input form-control from-input-sm" readonly value="0">  <!-- Smaller input -->
              </div>
              <div class="form-group d-flex align-items-center justify-content-between">
                <label for="discount" class="mb-0" style="min-width: 100px;">Discount %:</label>
                <input type="number" id="discount" value="0" class="form-control from-input form-control from-input-sm" placeholder="0" oninput="applyDiscount()">
              </div>
              <hr>
              <div class="form-group form-check mb-2">
                <input type="checkbox" class="form-check-input" id="enableGST" onchange="applyGST()">
                <label class="form-check-label" for="enableGST">GST (18%)</label>  <!-- Shortened label -->
              </div>
              <div class="form-group d-flex align-items-center justify-content-between mb-2">
                <label class="mb-0" style="min-width: 100px;">GST Amt:</label>  <!-- Shortened label -->
                <input type="number" id="gstAmount" class="form-control from-input form-control from-input-sm" readonly value="0">
              </div>
              <div class="form-group d-flex align-items-center justify-content-between mb-2">  <!-- Smallest margin -->
                <label for="grandTotal" class="mb-0" style="min-width: 100px;">Grand Total:</label>
                <input type="number" id="grandTotal" class="form-control from-input form-control from-input-sm font-weight-bold" readonly value="0">  <!-- Bold for emphasis -->
              </div>
              
            </div>
          </div>
        </div>
      </div>

    <!-- Generate Bill Button -->
    <div class="text-center mt-2">
      <button class="btn btn1 w-100 mb-1" onclick="generateBill()" style="height: 60px; font-size: 1.20rem;">
        <i class="fas fa-bolt"></i> <span>Generate Bill</span>   
      </button>
      
    <!-- Add this above the Generate Bill button -->
<div class="row mb-3">
  <div class="col-md-12">
    
  </div>
</div>
    </div>
  </div>
<!-- Due Amount Modal -->
<div class="modal fade" id="dueAmountModal" tabindex="-1" role="dialog" aria-labelledby="dueAmountModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dueAmountModalLabel">Enter Due Amount</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="dueAmount">Due Amount:</label>
          <input type="number" class="form-control" id="dueAmount" placeholder="Enter due amount">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveDueAmount()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Other Remarks Modal -->
<div class="modal fade" id="otherRemarksModal" tabindex="-1" role="dialog" aria-labelledby="otherRemarksModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="otherRemarksModalLabel">Enter Remarks</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="customRemarks">Remarks:</label>
          <input type="text" class="form-control text-capitalize" id="customRemarks" placeholder="Enter your remarks">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveOtherRemarks()">Save</button>
      </div>
    </div>
  </div>
</div>
  <!-- Scripts -->
  <script src="css/all.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

  <script>
  
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();


    let productData = [];
    let grandTotal = 0;

    // Fetch product data from JSON file
    function fetchProducts() {
      database.ref("products").on("value", snapshot => {
        let productSelect = document.getElementById("productSelect");
        productSelect.innerHTML = '<option value="">Select Product</option>';
        snapshot.forEach(childSnapshot => {
          let product = childSnapshot.val();
          let option = document.createElement("option");
          option.value = product.price;
          option.textContent = product.name;
          productSelect.appendChild(option);
        });
        $('.selectpicker').selectpicker('refresh');
      });
    }

    function updatePrice() {
      let productSelect = document.getElementById("productSelect");
      let priceInput = document.getElementById("price");
      priceInput.value = productSelect.value ? productSelect.value : "";
    }

//     function addItem() {
//   let productSelect = document.getElementById("productSelect");
//   let price = parseFloat(document.getElementById("price").value);
//   let quantity = parseInt(document.getElementById("quantity").value);
//   let productName = productSelect.options[productSelect.selectedIndex].text;

//   if (!productName || isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
//     showMessagered('Please select a valid product and enter quantity.');
//     return;
//   }

//   let total = price * quantity;
//   grandTotal += total;

//   let table = document.getElementById("billTable");
//   let rowCount = table.rows.length;
//   let row = table.insertRow();
  
//   row.innerHTML = `
//     <td>${rowCount + 1}</td>
//     <td>${productName}</td>
//     <td>₹${price.toFixed(2)}</td>
//     <td>
//       <div class="d-flex align-items-center">
//         <button class="btn btn-table btn-sm btn-danger d-none" onclick="decreaseQuantity(this, ${price})">
//           <i class="fas fa-minus"></i>
//         </button>
//         <span class="mx-2 quantity-display">${quantity}</span>
//         <button class="btn btn-table btn-sm btn-success" onclick="increaseQuantity(this, ${price})">
//           <i class="fas fa-plus"></i>
//         </button>
//       </div>
//     </td>
//     <td class="total-cell">₹${total.toFixed(2)}</td>
//     <td class="text-center align-middle">
//       <button class="btn  btn-danger btn-sm" onclick="removeItem(this)">
//         <i class="fas fa-trash"></i>
//       </button>
//     </td>
//   `;
  
//   // Store the price as a data attribute for later reference
//   row.querySelector('.total-cell').dataset.price = price;
//   row.querySelector('.total-cell').dataset.quantity = quantity;

//   updateTotals();
//   document.getElementById("quantity").value = "";
// }

function addItem() {
  let productSelect = document.getElementById("productSelect");
  let price = parseFloat(document.getElementById("price").value);
  let quantity = parseInt(document.getElementById("quantity").value);
  let productName = productSelect.options[productSelect.selectedIndex].text;

  if (!productName || isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
    showMessagered('Please select a valid product and enter quantity.');
    return;
  }

  // Check if product already exists in the table
  let table = document.getElementById("billTable");
  let existingRow = null;
  
  // Search all rows for matching product name
  for (let i = 0; i < table.rows.length; i++) {
    let row = table.rows[i];
    if (row.cells[1].textContent === productName) {
      existingRow = row;
      break;
    }
  }

  if (existingRow) {
    // Product exists - update quantity instead of adding new row
    let currentQuantity = parseInt(existingRow.querySelector('.quantity-display').textContent);
    let newQuantity = currentQuantity + quantity;
    let rowPrice = parseFloat(existingRow.querySelector('.price-input').value);
    
    // Update quantity display
    existingRow.querySelector('.quantity-display').textContent = newQuantity;
    
    // Update total
    let newTotal = rowPrice * newQuantity;
    existingRow.querySelector('.total-cell').textContent = `₹${newTotal.toFixed(2)}`;
    existingRow.querySelector('.total-cell').dataset.quantity = newQuantity;
    
    // Update grand total
    grandTotal += (rowPrice * quantity);
  } else {
    // Product doesn't exist - add new row
    let total = price * quantity;
    grandTotal += total;

    let rowCount = table.rows.length;
    let row = table.insertRow();
    
    row.innerHTML = `
      <td>${rowCount + 1}</td>
      <td>${productName}</td>
      <td><input type="number" class="form-control form-control-sm price-input" value="${price.toFixed(2)}" oninput="updateRowTotal(this)"></td>
      <td>
        <div class="d-flex align-items-center">
          <button class="btn btn-table btn-sm btn-danger" onclick="decreaseQuantity(this, this.parentElement.parentElement.parentElement.querySelector('.price-input').value)">
            <i class="fas fa-minus"></i>
          </button>
          <span class="mx-2 quantity-display">${quantity}</span>
          <button class="btn btn-table btn-sm btn-success" onclick="increaseQuantity(this, this.parentElement.parentElement.parentElement.querySelector('.price-input').value)">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </td>
      <td class="total-cell">₹${total.toFixed(2)}</td>
      <td class="text-center align-middle">
        <button class="btn btn-danger btn-sm" onclick="removeItem(this)">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    
    // Store the initial price and quantity as data attributes
    row.querySelector('.total-cell').dataset.price = price;
    row.querySelector('.total-cell').dataset.quantity = quantity;
  }

  updateTotals();
  document.getElementById("quantity").value = "";
}

// New function to update row total when price changes
function updateRowTotal(inputElement) {
  const row = inputElement.closest('tr');
  const price = parseFloat(inputElement.value) || 0;
  const quantity = parseInt(row.querySelector('.quantity-display').textContent) || 0;
  const totalCell = row.querySelector('.total-cell');
  
  // Calculate new total
  const newTotal = price * quantity;
  totalCell.textContent = `₹${newTotal.toFixed(2)}`;
  
  // Update data attributes
  totalCell.dataset.price = price;
  totalCell.dataset.quantity = quantity;
  
  // Recalculate grand total
  recalculateGrandTotal();
}

// Function to recalculate grand total after any changes
function recalculateGrandTotal() {
  grandTotal = 0;
  const rows = document.querySelectorAll("#billTable tr");
  
  rows.forEach(row => {
    const totalCell = row.querySelector('.total-cell');
    if (totalCell) {
      const total = parseFloat(totalCell.textContent.replace('₹', '')) || 0;
      grandTotal += total;
    }
  });
  
  updateTotals();
}

function removeItem(button, itemTotal) {
  // Use the actual total from the data attribute if available
  const row = button.parentElement.parentElement;
  const totalCell = row.querySelector('td:nth-child(5)');
  const actualTotal = parseFloat(totalCell.textContent.replace("₹", "")) || itemTotal;
  
  let table = row.parentElement;
  row.remove();
  grandTotal -= actualTotal;
  
  // Renumber all remaining rows
  let rows = table.rows;
  for (let i = 0; i < rows.length; i++) {
    rows[i].cells[0].textContent = i + 1; // Update serial number
  }
  
  updateTotals();
}

    function updateTotals() {
      document.getElementById("subTotal").value = grandTotal.toFixed(2);
      applyDiscount();
      applyGST();
    }

    function applyDiscount() {
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      const subTotal = parseFloat(document.getElementById("subTotal").value) || 0;
      
      if (discount < 0 || discount > 100) {
        alert("Discount must be between 0% and 100%");
        document.getElementById("discount").value = "";
        return;
      }

      applyGST();
    }

    function applyGST() {
      const gstEnabled = document.getElementById("enableGST").checked;
      const subTotal = parseFloat(document.getElementById("subTotal").value) || 0;
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      
      let discountedAmount = subTotal;
      if (discount > 0) {
        discountedAmount = subTotal - (subTotal * discount / 100);
      }

      if (gstEnabled) {
        const gstAmount = discountedAmount * 0.18;
        document.getElementById("gstAmount").value = gstAmount.toFixed(2);
        document.getElementById("grandTotal").value = (discountedAmount + gstAmount).toFixed(2);
      } else {
        document.getElementById("gstAmount").value = "0";
        document.getElementById("grandTotal").value = discountedAmount.toFixed(2);
      }
    }

// Add this function to generate the next Bill ID
// async function getNextBillId() {
//   try {
//     const snapshot = await database.ref("bills").orderByKey().limitToLast(1).once("value");
//     let lastBillId = "BTB0"; // Default starting point
    
//     if (snapshot.exists()) {
//       const lastBillKey = Object.keys(snapshot.val())[0];
//       const lastBillData = snapshot.val()[lastBillKey];
      
//       if (lastBillData.billId) {
//         lastBillId = lastBillData.billId;
//       }
//     }
    
//     // Extract the number part and increment
//     const lastNumber = parseInt(lastBillId.replace("BTB", "")) || 0;
//     return `BTB${lastNumber + 1}`;
//   } catch (error) {
//     console.error("Error fetching last bill ID:", error);
//     return "BTB1"; // Fallback if there's an error
//   }
// }

// async function getNextBillId() {
//   try {
//     // 1. Get current date components
//     const now = new Date();
//     const currentYear = now.getFullYear().toString().slice(-2); // e.g., "25"
//     const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
//     const currentMonth = monthNames[now.getMonth()]; // e.g., "APR"

//     // 2. Format: B25APRTB[number]
//     const prefix = `B${currentYear}${currentMonth}TB`;

//     // 3. Query the last bill of the current month
//     const snapshot = await database.ref("bills")
//       .orderByChild("billId")
//       .startAt(prefix)
//       .endAt(prefix + "\uf8ff")
//       .limitToLast(50) // More for safety
//       .once("value");

//     let lastNumber = 0;

//     if (snapshot.exists()) {
//       const bills = Object.values(snapshot.val());

//       for (const bill of bills) {
//         if (bill.billId && bill.billId.startsWith(prefix)) {
//           const num = parseInt(bill.billId.replace(prefix, ''), 10);
//           if (!isNaN(num) && num > lastNumber) {
//             lastNumber = num;
//           }
//         }
//       }

//      // console.log("Last Bill Number:", lastNumber);
//     }

//     // 4. Create next bill ID
//     const nextNumber = lastNumber + 1;

//     if (nextNumber > 99999) {
//       throw new Error("Maximum 99999 bills per month exceeded.");
//     }

//     const paddedNumber = nextNumber.toString().padStart(5, '0'); // e.g., TB00001
//     const newBillId = `${prefix}${paddedNumber}`;

//     // console.log("New Bill ID:", newBillId);
//     return newBillId;

//   } catch (error) {
//     console.error("Error generating bill ID:", error);
//     const now = new Date();
//     const currentYear = now.getFullYear().toString().slice(-2);
//     const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
//     const currentMonth = monthNames[now.getMonth()];
//     return `B${currentYear}${currentMonth}TB00001`;
//   }
// }

async function getNextBillId() {
  try {
    // 1. Get current date components
    const now = new Date();
    const currentYear = now.getFullYear().toString().slice(-2); // e.g., "25"
    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
    const currentMonth = monthNames[now.getMonth()]; // e.g., "APR"

    // 2. Format: B25APRTB[number]
    const prefix = `B${currentYear}${currentMonth}TB`;

    // 3. Query both active bills and trashBills for the current month's prefix
    const [activeBillsSnapshot, trashBillsSnapshot] = await Promise.all([
      database.ref("bills")
        .orderByChild("billId")
        .startAt(prefix)
        .endAt(prefix + "\uf8ff")
        .limitToLast(50)
        .once("value"),
      database.ref("trashBills")
        .orderByChild("billId")
        .startAt(prefix)
        .endAt(prefix + "\uf8ff")
        .limitToLast(50)
        .once("value")
    ]);

    let lastNumber = 0;

    // Check active bills
    if (activeBillsSnapshot.exists()) {
      const bills = Object.values(activeBillsSnapshot.val());
      for (const bill of bills) {
        if (bill.billId && bill.billId.startsWith(prefix)) {
          const num = parseInt(bill.billId.replace(prefix, ''), 10);
          if (!isNaN(num) && num > lastNumber) {
            lastNumber = num;
          }
        }
      }
    }

    // Check trashed bills
    if (trashBillsSnapshot.exists()) {
      const trashedBills = Object.values(trashBillsSnapshot.val());
      for (const bill of trashedBills) {
        if (bill.billId && bill.billId.startsWith(prefix)) {
          const num = parseInt(bill.billId.replace(prefix, ''), 10);
          if (!isNaN(num) && num > lastNumber) {
            lastNumber = num;
          }
        }
      }
    }

    // 4. Create next bill ID
    const nextNumber = lastNumber + 1;

    if (nextNumber > 99999) {
      throw new Error("Maximum 99999 bills per month exceeded.");
    }

    const paddedNumber = nextNumber.toString().padStart(5, '0'); // e.g., TB00001
    const newBillId = `${prefix}${paddedNumber}`;

    return newBillId;

  } catch (error) {
    console.error("Error generating bill ID:", error);
    // Fallback to first ID of the month if there's any error
    const now = new Date();
    const currentYear = now.getFullYear().toString().slice(-2);
    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
    const currentMonth = monthNames[now.getMonth()];
    return `B${currentYear}${currentMonth}TB00001`;
  }
}


// Modify your generateBill function to include the billId
async function generateBill() {
  // Check if there are any items in the bill table
  const billTable = document.getElementById("billTable");
  if (billTable.rows.length === 0) {
    showMessagered('Please add at least one item before generating the bill.');
    return;
  }

  // Get the selected bill type
  const billType = document.getElementById("billType").value;

  // Disable the button to prevent multiple clicks
  const generateBtn = document.querySelector('button[onclick="generateBill()"]');
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

  // Get the next bill ID
  const billId = await getNextBillId();
  document.getElementById("billId").value = billId;

  const customerName = document.getElementById("customerName").value || "Walk-in Customer";
  const customerMobile = document.getElementById("customerMobile").value || "";
  const subTotal = document.getElementById("subTotal").value;
  const discount = document.getElementById("discount").value;
  const gstAmount = document.getElementById("gstAmount").value;
  const grandTotal = document.getElementById("grandTotal").value;
  const remarks = document.getElementById("remarks").value || "";

  let formattedRemarks = "";
  if (remarksData.type === "DUE" && remarksData.dueAmount) {
    formattedRemarks = `Due: ${remarksData.dueAmount}`;
  } else if (remarksData.type === "Other" && remarksData.customRemarks) {
    formattedRemarks = remarksData.customRemarks;
  } else {
    formattedRemarks = remarksData.type;
  }

  const items = Array.from(document.querySelectorAll("#billTable tr")).map(row => {
    let cells = row.getElementsByTagName("td");
    if (cells.length === 6) {
      // Get the price from the input field instead of the cell text
      const priceInput = row.querySelector('.price-input');
      const price = priceInput ? parseFloat(priceInput.value) : 0;
      
      return {
        name: cells[1].textContent.trim(),
        price: price,
        quantity: parseInt(cells[3].textContent.trim()) || 0,
        total: parseFloat(cells[4].textContent.replace("₹", "").trim()) || 0
      };
    }
  }).filter(item => item && item.name);

  const billData = {
    billId: billId,
    customer: { name: customerName, mobile: customerMobile },
    items,
    subTotal,
    discount,
    gstAmount,
    grandTotal,
    remarks: formattedRemarks,
    date: combineDateTime(
      document.getElementById("billDate").value,
      document.getElementById("billTime").value
    ) || new Date().toISOString()
  };

  // Save to database
  const newBillRef = database.ref("bills").push();
  
  // First save the bill
  newBillRef.set(billData)
    .then(() => {
      // After saving the bill, update stock quantities
      return updateStockQuantities(items);
    })
    .then(() => {
      localStorage.setItem("currentBillData", JSON.stringify(billData));
      window.location.href = billType;
    })
    .catch((error) => {
      console.error("Error saving bill:", error);
      showMessagered("Error generating bill. Please try again.");
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-bolt"></i> <span>Generate Bill</span>';
    });
}

// Function to update stock quantities in Firebase
async function updateStockQuantities(items) {
  // Get all products from Firebase
  const snapshot = await database.ref("products").once("value");
  const products = snapshot.val();
  
  // Create an object to store all updates
  const updates = {};
  
  // Process each item in the bill
  for (const item of items) {
    // Find the product in our products list
    for (const productId in products) {
      const product = products[productId];
      if (product.name === item.name) {
        // Only update if stockQuantity exists and is greater than 0
        if (product.stockQuantity && product.stockQuantity > 0) {
          const newQuantity = product.stockQuantity - item.quantity;
          updates[`products/${productId}/stockQuantity`] = Math.max(0, newQuantity);
        }
        break; // Move to next item once we find the product
      }
    }
  }
  
  // If we have updates, apply them
  if (Object.keys(updates).length > 0) {
    return database.ref().update(updates);
  }
  
  return Promise.resolve();
}

// Function to find product by name (used in other parts of the code)
async function findProductByName(productName) {
  const snapshot = await database.ref("products").orderByChild("name").equalTo(productName).once("value");
  if (snapshot.exists()) {
    const products = snapshot.val();
    // Return the first product found (should be unique if names are unique)
    return products[Object.keys(products)[0]];
  }
  return null;
}

function combineDateTime(dateString, timeString) {
  if (!dateString) return null;
  
  // If no time is provided, default to current time
  if (!timeString) {
    timeString = new Date().toTimeString().substring(0, 5);
  }
  
  // Combine date and time into ISO format
  const dateTimeString = `${dateString}T${timeString}:00`;
  const dateTime = new Date(dateTimeString);
  
  // Return as ISO string (includes timezone offset)
  return dateTime.toISOString();
}

// Call this when the page loads to display the next bill ID
document.addEventListener('DOMContentLoaded', async function() {
  const nextBillId = await getNextBillId();
  document.getElementById("billId").value = nextBillId;

   // Set default date and time to now
  const now = new Date();
  document.getElementById("billDate").value = now.toISOString().split('T')[0];
  document.getElementById("billTime").value = now.toTimeString().substring(0, 5);
  
  // Rest of your existing DOMContentLoaded code...
  fetchProducts();
  fetchCustomers();
});

// Clear barcode scanner data on page load
document.addEventListener('DOMContentLoaded', function() {
  // Clear any existing barcode input
  document.getElementById('barcodeInput').value = '';
  
  // Reset scanner state
  isBarcodeScanning = false;
  
  // Clear any related localStorage/sessionStorage
  localStorage.removeItem('lastBarcodeScan');
  sessionStorage.removeItem('barcodeScanInProgress');
  
  // Initialize scanner with fresh state
  initializeScanner();
});

function initializeScanner() {
  // Add any scanner initialization code here
  console.log('Scanner initialized for this session');
}

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }
   
//    auth.onAuthStateChanged(user => {
 // if (!user) {
 //   window.location.href = "login.html"; // Redirect to login if not authenticated
//  }
//});

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html"; // Redirect if not logged in
  } else {
    const mainContent = document.getElementById('main-content');
    
    // Check if user is toributik33@gmail.com
    if (user.email === "toributik33@gmail.com") {
      mainContent.classList.remove('hide-auth'); // Show content
    } else {
      mainContent.classList.add('hide-auth'); // Hide content

    }
  }
});


    fetchProducts();


function fetchCustomers() {
    database.ref("bills").on("value", (snapshot) => {
        let nameToMobile = {};
        let mobileToName = {};
        snapshot.forEach((childSnapshot) => {
            let bill = childSnapshot.val();
            if (bill.customer && bill.customer.name && bill.customer.mobile) {
                nameToMobile[bill.customer.name] = bill.customer.mobile;
                mobileToName[bill.customer.mobile] = bill.customer.name;
            }
        });

        // Store these mappings in the window object for easy access
        window.customerData = {
            nameToMobile: nameToMobile,
            mobileToName: mobileToName
        };

        // Update the datalist for name suggestions
        let datalist = document.getElementById("customerList");
        datalist.innerHTML = "";
        for (let name in nameToMobile) {
            let option = document.createElement("option");
            option.value = name;
            option.dataset.mobile = nameToMobile[name];
            datalist.appendChild(option);
        }
    });
}


function fillCustomerMobile() {
    let customerName = document.getElementById("customerName").value;
    let options = document.querySelectorAll("#customerList option");

    for (let option of options) {
        if (option.value === customerName) {
            document.getElementById("customerMobile").value = option.dataset.mobile;
            return;
        }
    }
}

// Fetch customers on page load
fetchCustomers();


// Update your showSuccessMessage function to accept a custom message
function showMessage(message = "sdsf ") {
      const messageDiv = document.getElementById("productMessage");
      messageDiv.innerHTML = `<p class="indi"><i class="fa-solid fa-xmark"></i> ${message}</p>`;
      messageDiv.style.display = "block";
      
      // Hide the message after 3 seconds
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 4000);
    }

    function showMessagered(message = "sdsf ") {
      const messageDiv = document.getElementById("productMessage");
      messageDiv.innerHTML = `<p class="indi-red"><i class="fa-solid fa-xmark"></i> ${message}</p>`;
      messageDiv.style.display = "block";
      
      // Hide the message after 3 seconds
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 4000);
    }



    // Global variables to store remarks data
let remarksData = {
  type: "",
  dueAmount: "",
  customRemarks: ""
};

function handleRemarksChange() {
  const remarksSelect = document.getElementById("remarks");
  const selectedValue = remarksSelect.value;
  
  remarksData.type = selectedValue;
  
  if (selectedValue === "DUE") {
    $('#dueAmountModal').modal('show');
  } else if (selectedValue === "Other") {
    $('#otherRemarksModal').modal('show');
  } else {
    // For UPI and Cash, just use the selected value
    remarksData.dueAmount = "";
    remarksData.customRemarks = "";
  }
}

function saveDueAmount() {
  const dueAmount = document.getElementById("dueAmount").value;
  if (!dueAmount || isNaN(dueAmount) || parseFloat(dueAmount) <= 0) {
    alert("Please enter a valid due amount");
    return;
  }
  
  remarksData.dueAmount = dueAmount;
  $('#dueAmountModal').modal('hide');
  document.getElementById("dueAmount").value = ""; // Clear the input for next time
}

function saveOtherRemarks() {
  const customRemarks = document.getElementById("customRemarks").value;
  if (!customRemarks || customRemarks.trim() === "") {
    alert("Please enter remarks");
    return;
  }
  
  remarksData.customRemarks = customRemarks;
  $('#otherRemarksModal').modal('hide');
  document.getElementById("customRemarks").value = ""; // Clear the input for next time
}


// Global variable to track barcode scanner state
let isScannerActive = false;

// Add this event listener to detect scanner activation
document.addEventListener('keydown', function(event) {
  // Common barcode scanner activation sequences (you may need to adjust these)
  // Some scanners send a prefix like "Shift" or "Alt" when activated
  if (event.key === 'Shift' || event.key === 'Alt' || event.key === 'Control') {
    isScannerActive = true;
    startBarcodeScan();
  }
});

// Also detect when scanning might be done (optional)
document.addEventListener('keyup', function(event) {
  if (event.key === 'Shift' || event.key === 'Alt' || event.key === 'Control') {
    isScannerActive = false;
  }
});

// Global variable to track if we're in barcode scanning mode
let isBarcodeScanning = false;

function startBarcodeScan() {
  isBarcodeScanning = true;
  const scanBtn = document.querySelector('button[onclick="startBarcodeScan()"]');
  scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
  scanBtn.classList.remove('btn-info');
  scanBtn.classList.add('btn-warning');
  
  // Show and focus the hidden barcode input
  const barcodeInput = document.getElementById('barcodeInput');
  barcodeInput.classList.remove('d-none');
  barcodeInput.focus();
  
  // Show message to user
  showMessage('Ready to scan - point barcode scanner at this window');
}

function stopBarcodeScan() {
  isBarcodeScanning = false;
  const scanBtn = document.querySelector('button[onclick="startBarcodeScan()"]');
  scanBtn.innerHTML = '<i class="fas fa-barcode"></i> Scan Barcode';
  scanBtn.classList.remove('btn-warning');
  scanBtn.classList.add('btn-info');
  
  // Hide the barcode input
  document.getElementById('barcodeInput').classList.add('d-none');
}



let scanTimeout;
const barcodeInput = document.getElementById('barcodeInput');

barcodeInput.addEventListener('input', function () {
  if (!isBarcodeScanning) return;

  clearTimeout(scanTimeout);

  // Wait 300ms to allow the scanner to finish inputting all characters
  scanTimeout = setTimeout(() => {
    const barcode = barcodeInput.value.trim();
    if (barcode.length > 0) {
      lookupProductByBarcode(barcode);
      barcodeInput.value = '';
    }
  }, 300); // adjust timeout if necessary
});



// Function to lookup product by barcode
function lookupProductByBarcode(barcode) {
  // First check if we have the product data already loaded
  const product = findProductByBarcode(barcode);
  
  if (product) {
    // Product found - auto-fill the form
    autoFillProductForm(product);
    stopBarcodeScan();
  } else {
    // Product not found in local data - try fetching from Firebase
    fetchProductByBarcodeFromFirebase(barcode);
  }
}

// Helper function to find product in local data
function findProductByBarcode(barcode) {
  // This assumes you have a global productData array with all products
  // If not, you'll need to fetch from Firebase
  return productData.find(p => p.barcode === barcode);
}

// Function to fetch product from Firebase by barcode
function fetchProductByBarcodeFromFirebase(barcode) {
  database.ref("products").orderByChild("barcode").equalTo(barcode).once("value")
    .then(snapshot => {
      if (snapshot.exists()) {
        const product = Object.values(snapshot.val())[0];
        autoFillProductForm(product);
        stopBarcodeScan();
      } else {
        showMessagered('Product not found for barcode: ' + barcode);
        stopBarcodeScan();
      }
    })
    .catch(error => {
      console.error("Error fetching product:", error);
      showMessagered('Error looking up product');
      stopBarcodeScan();
    });
}


// Function to auto-fill the product form
function autoFillProductForm(product) {
  const productSelect = document.getElementById('productSelect');
  
  // Find the option that matches this product
  for (let i = 0; i < productSelect.options.length; i++) {
    if (productSelect.options[i].text === product.name) {
      productSelect.selectedIndex = i;
      $('.selectpicker').selectpicker('refresh');
      break;
    }
  }
  
  // Set the price
  document.getElementById('price').value = product.price;
  
  // Focus on quantity field for quick entry
  //document.getElementById('quantity').focus();
  document.getElementById('quantity').value = 1;
  addItem();
  showMessage(`Product found: ${product.name}`);
  playBeepSound();
}

// Function to play a beep sound
function playBeepSound() {
  try {
    // Option 1: Using Web Audio API (no external files needed)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine'; // Type of sound wave
    oscillator.frequency.value = 1000; // Frequency in hertz
    gainNode.gain.value = 0.3; // Volume
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1); // Duration in seconds
    
  } catch (e) {
    console.error("Couldn't play beep sound:", e);
  }
}

// Update increaseQuantity and decreaseQuantity functions to use the current price
function increaseQuantity(button, price) {
  const row = button.closest('tr');
  const currentPrice = parseFloat(row.querySelector('.price-input').value) || 0;
  const quantityDisplay = row.querySelector('.quantity-display');
  const totalCell = row.querySelector('.total-cell');
  
  let quantity = parseInt(quantityDisplay.textContent);
  quantity++;
  quantityDisplay.textContent = quantity;
  
  // Update the total
  const newTotal = currentPrice * quantity;
  totalCell.textContent = `₹${newTotal.toFixed(2)}`;
  totalCell.dataset.quantity = quantity;
  
  // Update grand total
  recalculateGrandTotal();
}

function decreaseQuantity(button, price) {
  const row = button.closest('tr');
  const currentPrice = parseFloat(row.querySelector('.price-input').value) || 0;
  const quantityDisplay = row.querySelector('.quantity-display');
  const totalCell = row.querySelector('.total-cell');
  
  let quantity = parseInt(quantityDisplay.textContent);
  
  if (quantity > 1) {
    quantity--;
    quantityDisplay.textContent = quantity;
    
    // Update the total
    const newTotal = currentPrice * quantity;
    totalCell.textContent = `₹${newTotal.toFixed(2)}`;
    totalCell.dataset.quantity = quantity;
    
    // Update grand total
    recalculateGrandTotal();
  }
}
  </script>
</body>
</html>
