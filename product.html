<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Products</title>
  <link rel="icon" type="image/png" href="img/logotab.png">
  <link href="css/bg.css" rel="stylesheet">
  <script src="css/all.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Add JsBarcode library -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- Add jsPDF and html2canvas libraries -->
   <!-- Add JSZip library for zip file creation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
    .spinner {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .barcode-container {
      margin-top: 10px;
      text-align: center;
    }
    .barcode {
      height: 50px;
      max-width: 100%;
    }
    .barcode-label {
      font-size: 12px;
      margin-top: 5px;
    }
    .product-barcode {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .export-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
     /* Previous styles remain the same */
     .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      text-align: center;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .barcode-only-btn {
      background-color: #4CAF50;
      color: white;
    }
    .all-info-btn {
      background-color: #2196F3;
      color: white;
    }
    .cancel-btn {
      background-color: #f44336;
      color: white;
    }
    .sort-btn {
      cursor: pointer;
      margin-left: 5px;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
      
      .row.mb-1 {
        margin-bottom: 5px !important;
      }
      
     
      
      #productList {
        padding-left: 0;
      }
      
      .glass {
        flex-direction: column;
        padding: 10px;
      }
      
      .product-info {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .product-actions {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }
      
      .barcode-and-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }
      
      .product-buttons {
        display: flex;
        justify-content: flex-end;
        width: 100%;
        margin-top: 10px;
      }
      
      .export-buttons {
        justify-content: center;
      }
      
      .export-buttons button {
        margin-bottom: 5px;
        font-size: 12px;
        padding: 5px 8px;
      }
      
      #generateAllBarcodesBtn, #exportExcelBtn, #exportPdfBtn {
        font-size: 12px;
      }
    }
    
    /* Additional styles for new fields */
    .profit-display {
      font-size: 12px;
      color: #28a745;
      font-weight: bold;
      display: none;
    }
    
    .stock-display {
      font-size: 12px;
      color: #00515e;
      font-weight: bold;
      background-color: rgba(224, 255, 255, 0.534);
      padding: 2px;
      border-radius: 5px;
    }

    #generateAllBarcodesBtn {
  display: none;
}

.missing-info {
    border-left: 5px solid #ff032d;
  }

  
  .missing-info::after {
    content: 'Please update: ' attr(data-missing-fields);
    position: absolute;
    bottom: 3px;
    font-size: 12px;
    color: #ff032d;
  }

  .from-input-p {
  box-shadow: inset 0 0 8px rgba(0, 119, 119, 0.3);
  border-radius: 12px;
  border: 1.5px solid rgba(0, 119, 119, 0.4);
  padding: 10px 14px;
  transition: all 0.3s ease;
  font-size: 1rem;
  background-color: #f9ffff;
}

.from-input-p:focus {
  border: 2px solid rgb(1, 78, 1);
  box-shadow: 0 0 8px rgba(1, 78, 1, 0.6);
  outline: none;
  background-color: #ffffff;
}

.setting-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
}

.switch {
  position: relative;
  display: inline-block;
  width: 40px;  /* Reduced from 60px to better match the height */
  height: 20px; /* Changed from 34px to 20px */
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;  /* Reduced from 26px */
  width: 16px;   /* Reduced from 26px */
  left: 2px;     /* Adjusted from 4px */
  bottom: 2px;   /* Adjusted from 4px */
  background-color: white;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:checked + .slider:before {
  transform: translateX(20px); /* Adjusted from 26px */
}

.slider.round {
  border-radius: 20px; /* Changed from 34px to match height */
}

.slider.round:before {
  border-radius: 50%;
}

@media print {
  body * {
    visibility: hidden;
  }
  #printContainer, #printContainer * {
    visibility: visible;
  }
  #printContainer {
    position: absolute;
    left: 0;
    top: 0;
    width: 2.5in;
    height: auto;
    margin: 0;
    padding: 10px;
    border: none;
  }
}

@import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
.modal-head-text{
  margin: 0px; 
  font-size: 12px; 
  font-weight: bold;
  font-family: "Rubik Mono One", monospace;
  text-transform: uppercase;
  padding: 2px;
}

.Design-2{
  margin: 0px; 
  font-size: 15px; 
  font-weight: bold;
  font-family: "Rubik Mono One", monospace;
  text-transform: uppercase;
  padding: 2px;
  justify-content: left;
  color: #00043f;
}
  </style>
</head>
<body>
  <div>
    <div class="particles" id="particles"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>
  <!-- Image and text -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
    <div class="container d-flex justify-content-between align-items-center">
      
      <!-- Back Button -->
      <a class="navbar-brand d-flex align-items-center" href="index.html" style="padding: 8px 12px; border-radius: 50%; background-color: #17a2b8;">
        <i class="fas fa-arrow-left text-white"></i>
      </a>
       
  
      <!-- Dropdown Menu -->
      <div class="dropdown">
        <button class="btn btn-outline-light dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-cog"></i><span class="d-none d-sm-inline"> Menu</span>
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
          <button id="exportBarcodeImagesBtn" class="btn  " onclick="downloadBarcodeImages()">
            <i class="fas fa-file-archive"></i> Barcode Images
          </button>
          
          <button id="downloadDemoBtn" class="btn" onclick="downloadDemoFormat()">
            <i class="fas fa-file-download"></i> Import Format
          </button>
          <button id="importExcelBtn" class="btn" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-file-import"></i> Import
          </button>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
          <button id="exportExcelBtn" class="btn" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
          <button id="exportPdfBtn" class="btn" onclick="showPdfOptions()">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
          <div class="dropdown-divider"></div>
          <button id="generateAllBarcodesBtn" class="btn" onclick="generateAllBarcodes()">
            <i class="fas fa-barcode"></i> Generate All
          </button>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </a>
          
        </div>
      </div>
    </div>
  </nav>
<!-- Print Modal -->
<div class="modal fade" id="printModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header" style="justify-content: center;">
        <h5 class="modal-title ">Download Barcode</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <div id="printTemplate" style="display: none;">
          <!-- Design 1  -->
          <!-- <div style="width: 2.5in; height: 1.5in; background: white; padding: 2px;  margin: 0 auto; border: 1px solid #050505;">
            <div style="border: 1px solid black;">
            <img src="img/tb-modal-tag.png" style=" width: 2.2in; height: auto; ">
            <h5 class="modal-head-text" style="border-top: 1px solid black;border-bottom: 1px solid black; background-color: #c7f7ff;" id="printProductName"><span id="printProductPrice"></span></h5>   
            <div class="text-center" style="margin: 2px auto; width: fit-content; " id="printBarcodeContainer">
            <span id="printBarcodeText" style="font-size: 9px; display: block;"></span>
            </div>              
            <h5 class="modal-head-text" style="font-size: 12px; border-top: 1px solid black;">Thank you! Visit us again. ðŸ›’</h5>
          </div>
          </div> -->
          <!-- Design 1  -->

          <!-- Design 2 -->
          <div style="width: 2.5in; height: 1.5in; background: white; padding: 2px; margin: 0 auto; border: 1px solid #050505;">
            <div style="border: 1px solid black; position: relative;">
              <!-- Image positioned absolutely to the right -->
              <img src="img/logotab.png" style="width: 0.7in; height: auto; position: absolute; right: 0; top: 20px;">
              
              <!-- Text container that will flow over the image -->
              <div class="text-left" style="position: relative; z-index: 1;">
                <h5 class="Design-2" style="border-bottom: 1px solid black; margin-right: 0.8in; white-space: nowrap;  text-overflow: ellipsis;" id="printProductName">
                  <span id="printProductPrice"></span>
                </h5>  
                <h5 class="modal-head-text" style="font-size: 12px; border-bottom: 1px solid black;margin-right: 0.8in; white-space: nowrap;  text-overflow: ellipsis;">Thank you!<br> Visit us again. ðŸ›’</h5>
 
              </div>
              
              <div class="text-center" style="margin: 2px auto; width: fit-content;" id="printBarcodeContainer">
                <span id="printBarcodeText" style="font-size: 9px; display: block;"></span>
              </div>
            </div>
          </div>
          <!-- Design 2 -->

        
        
        </div>
        <!-- Preview container -->
        <div id="printPreview"></div>
      </div>
      <div class="modal-footer " style="justify-content: center;">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn1 text-light" onclick="downloadBarcodeImage()">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>
  </div>
</div>
  <div class="container mt-5" style="padding-top: 20px;">
    <div id="productMessage">
      <p class="indi"> <i class="fa-solid fa-circle-check"></i> Success</p>
    </div>

    <div class="d-flex align-items-center mb-3 gap-2">
      <input type="text" id="searchProduct" class="form-control from-input-p mr-1" placeholder="Search Products" onkeyup="searchProducts()">
      <span class="bg-info text-white px-3 py-2 rounded border d-inline-block nowrap mr-1" id="productCount">0</span>
      <span id="sortButton" class="btn btn-outline-secondary py-2 px-3" title="Sort by name" onclick="toggleSort()">
        <i class="fas fa-sort-alpha-down"></i>
      </span>
      <span class="btn   px-3" title="Calculate Average Purchase Price">
        <label class="switch">
          <input type="checkbox" id="averagePriceToggle" >
          <span class="slider round"></span>
        </label> 
      </span>
    </div>
    <div class="row mb-1">
      <div class="col-md-2 col-6">
        <input type="text" id="productName" class="form-control from-input-p mb-1" placeholder="Product Name" autocomplete="off">
      </div>
      <div class="col-md-2 col-6">
        <input type="number" id="productPrice" class="form-control from-input-p mb-1" placeholder="Selling Price" autocomplete="off">
      </div>
      <div class="col-md-2 col-6">
        <input type="number" id="purchasePrice" class="form-control from-input-p mb-1" placeholder="Purchase Price" autocomplete="off">
      </div>
      <div class="col-md-2 col-6">
        <input type="number" id="stockQuantity" class="form-control from-input-p mb-1" placeholder="Stock Quantity" autocomplete="off">
      </div>
      <div class="col-md-2 col-6 d-none">
        <input type="text" id="productBarcode" class="form-control from-input-p mb-1" placeholder="Barcode (auto)" autocomplete="off" readonly>
      </div>
      <div class="col-md-4 ">
        <button id="addProductBtn" class="btn btn2 text-light mb-1 w-100" onclick="addOrUpdateProduct()"> <i class="fas fa-plus-circle"></i> Add</button>
      </div>
    </div>
  
    <div class="setting-toggle">
      
      
    </div>

    <!-- Loading Spinner -->
    <div class="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- Product List -->
    <ul id="productList" class="list-group"></ul>
  </div>
<!-- Add this before Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    let editingProductKey = null;
    let allProducts = [];
    let sortDirection = 'asc'; // 'asc' or 'desc'

    function toggleSort() {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      updateSortButtonIcon();
      sortAndDisplayProducts();
    }

    function updateSortButtonIcon() {
      const sortButton = document.getElementById('sortButton');
      if (sortDirection === 'asc') {
        sortButton.innerHTML = '<i class="fas fa-sort-alpha-down"></i>';
        sortButton.title = "Sort by name (A-Z)";
      } else {
        sortButton.innerHTML = '<i class="fas fa-sort-alpha-up"></i>';
        sortButton.title = "Sort by name (Z-A)";
      }
    }

    function sortProducts(products) {
      return products.sort((a, b) => {
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        if (sortDirection === 'asc') {
          return nameA.localeCompare(nameB);
        } else {
          return nameB.localeCompare(nameA);
        }
      });
    }

    function sortAndDisplayProducts() {
      const sortedProducts = sortProducts([...allProducts]);
      displayProducts(sortedProducts);
    }

    function generateBarcode(name, price) {
      // Get first letter of name (uppercase)
      let firstLetter = name.trim().charAt(0).toUpperCase();
      
      // Format price (remove non-numeric characters)
      let formattedPrice = price.toString().replace(/\D/g, '');
      
      // Generate 3 random unique letters (uppercase)
      let randomLetters = '';
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const usedIndices = new Set();
      
      while (randomLetters.length < 3) {
        const randomIndex = Math.floor(Math.random() * letters.length);
        if (!usedIndices.has(randomIndex)) {
          usedIndices.add(randomIndex);
          randomLetters += letters.charAt(randomIndex);
        }
      }
      
      // Combine all parts
      let formattedBarcode = firstLetter + formattedPrice + randomLetters;
      
      document.getElementById("productBarcode").value = formattedBarcode;
    }


    function addOrUpdateProduct() {
  let name = document.getElementById("productName").value;
  let price = document.getElementById("productPrice").value;
  let newPurchasePrice = parseFloat(document.getElementById("purchasePrice").value);
  let newStockQuantity = parseInt(document.getElementById("stockQuantity").value);
  let barcode = document.getElementById("productBarcode").value;
  
  if (name && price && !isNaN(newPurchasePrice) && !isNaN(newStockQuantity)) {
    if (!barcode) {
      generateBarcode(name, price);
      barcode = document.getElementById("productBarcode").value;
    }
    
    // Get the calculation setting first
    database.ref("CalculateAverageForPurchasePrice").once('value')
      .then((settingSnapshot) => {
        const shouldCalculateAverage = settingSnapshot.val() === true;
        
        // Calculate profit (temporary using newPurchasePrice, will be updated later if editing)
        let profit = parseFloat(price) - newPurchasePrice;
        
        if (editingProductKey) {
          // First get the current product data
          return database.ref("products/" + editingProductKey).once('value')
            .then((productSnapshot) => {
              const productData = productSnapshot.val();
              const currentStock = parseInt(productData.stockQuantity) || 0;
              const currentPurchasePrice = parseFloat(productData.purchasePrice) || 0;
              const totalStock = currentStock + newStockQuantity;
              
              let finalPurchasePrice;
              
              if (shouldCalculateAverage && currentPurchasePrice !== newPurchasePrice) {
                // Calculate weighted average purchase price and round to nearest integer
                finalPurchasePrice = Math.round(
                  ((currentPurchasePrice * currentStock) + (newPurchasePrice * newStockQuantity)) / totalStock
                );
              } else {
                // Use the new purchase price directly
                finalPurchasePrice = Math.round(newPurchasePrice);
              }
              
              // Update with the summed stock quantity and final purchase price
              return database.ref("products/" + editingProductKey).update({ 
                name, 
                price, 
                purchasePrice: finalPurchasePrice,
                stockQuantity: totalStock,
                profit: parseFloat(price) - finalPurchasePrice,
                barcode 
              });
            });
        } else {
          // For new products, just use the provided purchase price (rounded)
          let finalPurchasePrice = Math.round(newPurchasePrice);
          let newProduct = database.ref("products").push();
          return newProduct.set({ 
            name, 
            price, 
            purchasePrice: finalPurchasePrice,
            stockQuantity: newStockQuantity,
            profit: parseFloat(price) - finalPurchasePrice,
            barcode 
          });
        }
      })
      .then(() => {
        showSuccessMessage();
        if (editingProductKey) {
          editingProductKey = null;
          document.getElementById("addProductBtn").innerHTML = '<i class="fas fa-plus-circle"></i> Add';
        }
        // Clear form fields
        document.getElementById("productName").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("purchasePrice").value = "";
        document.getElementById("stockQuantity").value = "";
        document.getElementById("productBarcode").value = "";
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while processing your request.");
      });
  } else {
    alert("Please fill all required fields with valid values!");
  }
}

   
    function fetchProducts() {
  document.querySelector(".spinner").style.display = "block";

  database.ref("products").on("value", snapshot => {
    document.querySelector(".spinner").style.display = "none";
    allProducts = [];
    snapshot.forEach(childSnapshot => {
      let product = childSnapshot.val();
      product.key = childSnapshot.key;
      allProducts.push(product);
    });
    sortAndDisplayProducts();
    
    // Check if we should show the generate barcodes button
    checkProductsWithoutBarcodes().then(showButton => {
      document.getElementById("generateAllBarcodesBtn").style.display = showButton ? "block" : "none";
    });
  });
}


function checkProductsWithoutBarcodes() {
  return new Promise((resolve) => {
    database.ref("products").once('value').then(snapshot => {
      let hasProductsWithoutBarcodes = false;
      
      snapshot.forEach(childSnapshot => {
        const product = childSnapshot.val();
        if (!product.barcode || product.barcode.trim() === '') {
          hasProductsWithoutBarcodes = true;
        }
      });
      
      resolve(hasProductsWithoutBarcodes);
    }).catch(error => {
      console.error("Error checking products:", error);
      resolve(false); // Default to not showing the button if there's an error
    });
  });
}

function displayProducts(products) {
    let productList = document.getElementById("productList");
    productList.innerHTML = "";
    document.getElementById("productCount").innerText = products.length;
    
    products.forEach(product => {
      let barcodeCanvasId = `barcode-${product.key}`;
      let barcodeContainer = `
        <div class="product-barcode text-center mb-2">
          <canvas id="${barcodeCanvasId}" class="barcode"></canvas>
          <div class="barcode-label text-muted small">${product.barcode || 'No barcode'}</div>
        </div>
      `;
      
      // Check for missing fields
      let missingFields = [];
      if (!product.purchasePrice || product.purchasePrice === 0) missingFields.push('purchase price');
      if (!product.stockQuantity || product.stockQuantity === 0) missingFields.push('stock quantity');
      
      // Add missing info class if needed
      let missingClass = missingFields.length > 0 ? 'missing-info' : '';
      let missingFieldsAttr = missingFields.length > 0 ? `data-missing-fields="${missingFields.join(', ')}"` : '';
      
      let productItem = `
        <li class="glass p-3 mb-3 w-100 ${missingClass}" ${missingFieldsAttr}>
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="product-info mb-3 mb-md-0 w-100">
              <h5 class="mb-1 text-primary">
                <i class="fas fa-box-open mr-2"></i>${product.name}
              </h5>
              <p class="mb-1 text-dark">
                <i class="fas fa-tag"></i> Price: <strong>â‚¹${product.price}</strong>
              </p>
              ${product.purchasePrice ? `
                <p class="mb-1 text-success">
                  <i class="fas fa-coins"></i> Profit: â‚¹${product.profit || (product.price - product.purchasePrice).toFixed(2)}
                </p>
              ` : ''}
              ${product.stockQuantity ? `
                <p class="mb-1 text-info">
                  <i class="fas fa-boxes"></i> Stock: ${product.stockQuantity}
                </p>
              ` : ''}
            </div>

            <div class="barcode-and-buttons d-flex flex-column align-items-center w-100 w-md-auto">
              ${barcodeContainer}

              <div class="product-buttons d-flex flex-wrap justify-content-center gap-2 mt-1 mb-2">
                <button class="btn btn-warning btn-sm mr-2" title="Edit" onclick="editProduct('${product.key}', '${product.name}', '${product.price}', '${product.purchasePrice || ''}', '${product.stockQuantity || ''}', '${product.barcode || ''}')">
                  <i class="fas fa-edit"></i><span class="d-none d-sm-inline"> Edit</span>
                </button>
                <button class="btn btn-info btn-sm mr-2" title="Download" onclick="downloadSingleBarcode('${product.key}', '${product.name}', '${product.price}', '${product.barcode}')">
                  <i class="fas fa-download"></i><span class="d-none d-sm-inline"> Download IMG</span>
                </button>
                <button class="btn btn-primary btn-sm mr-2" title="Print" onclick="showPrintModal('${product.key}', '${product.name}', '${product.price}', '${product.barcode}')">
                <i class="fas fa-download"></i><span class="d-none d-sm-inline"> Labels</span>
                </button>
                <button class="btn btn-danger btn-sm mr-2" title="Delete" onclick="deleteProduct('${product.key}')">
                  <i class="fas fa-trash"></i><span class="d-none d-sm-inline"> Delete</span>
                </button>
              </div>
            </div>
          </div>
        </li>
      `;
      productList.innerHTML += productItem;
      
      if (product.barcode) {
        setTimeout(() => {
          JsBarcode(`#${barcodeCanvasId}`, product.barcode, {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 50,
            displayValue: false
          });
        }, 100);
      }
    });
  }

    function searchProducts() {
      let searchValue = document.getElementById("searchProduct").value.toLowerCase();
      let filteredProducts = allProducts.filter(product => 
        product.name.toLowerCase().includes(searchValue) || 
        (product.barcode && product.barcode.toLowerCase().includes(searchValue))
      );
      displayProducts(filteredProducts);
    }

    function editProduct(key, name, price, purchasePrice, stockQuantity, barcode) {
      document.getElementById("productName").value = name;
      document.getElementById("productPrice").value = price;
      document.getElementById("purchasePrice").value = purchasePrice;
      document.getElementById("stockQuantity").value = 0;
      document.getElementById("productBarcode").value = barcode;
      editingProductKey = key;
      document.getElementById("addProductBtn").innerHTML = '<i class="fas fa-save"></i> Save';
      document.querySelector('.row.mb-1').scrollIntoView({ behavior: 'smooth', block: 'start' });
      document.getElementById("productName").focus();
    }

    function deleteProduct(key) {
      if (confirm("Are you sure you want to delete this product?")) {
        database.ref("products/" + key).remove()
          .then(() => {
            showSuccessMessage();
          })
          .catch((error) => {
            console.error("Error deleting product: ", error);
          });
      }
    }

    function showSuccessMessage() {
      const message = document.getElementById("productMessage");
      message.style.display = "block";
      message.style.opacity = 1;
      
      setTimeout(() => {
        message.style.opacity = 0;
        setTimeout(() => {
          message.style.display = "none";
        }, 500);
      }, 3000);
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        fetchProducts();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Auto-generate barcode when name or price changes
      document.getElementById("productName").addEventListener('input', function() {
        if (!editingProductKey) { // Only auto-generate when adding new products
          let name = this.value;
          let price = document.getElementById("productPrice").value;
          if (name && price) {
            generateBarcode(name, price);
          }
        }
      });

      document.getElementById("productPrice").addEventListener('input', function() {
        if (!editingProductKey) { // Only auto-generate when adding new products
          let price = this.value;
          let name = document.getElementById("productName").value;
          if (name && price) {
            generateBarcode(name, price);
          }
        }
      });

      document.getElementById("productBarcode").addEventListener('click', function() {
        let name = document.getElementById("productName").value;
        let price = document.getElementById("productPrice").value;
        if (!this.value && name && price) {
          generateBarcode(name, price);
        }
      });
      
      // Calculate profit when purchase price changes
      document.getElementById("purchasePrice").addEventListener('input', function() {
        const sellingPrice = parseFloat(document.getElementById("productPrice").value) || 0;
        const purchasePrice = parseFloat(this.value) || 0;
        const profit = sellingPrice - purchasePrice;
        // You can display this somewhere if you want
      });
    });

    async function exportToExcel() {
      // Show loading message
      const loadingMessage = document.createElement('div');
      loadingMessage.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Generating Excel file...</p></div>';
      document.body.appendChild(loadingMessage);

      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Prepare the data with barcode visualization
        const excelData = allProducts.map(product => ({
          'Product Name': product.name,
          'Selling Price': `â‚¹${product.price}`,
          'Purchase Price': `â‚¹${product.purchasePrice || 0}`,
          'Profit': `â‚¹${product.profit || (product.price - (product.purchasePrice || 0)).toFixed(2)}`,
          'Stock Quantity': product.stockQuantity || 0,
          'Barcode': product.barcode || '',
          'Barcode Visualization': generateTextBarcode(product.barcode)
        }));
        
        // Convert to worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Set column widths
        ws['!cols'] = [
          {wch: 20}, // Product Name
          {wch: 12}, // Selling Price
          {wch: 12}, // Purchase Price
          {wch: 12}, // Profit
          {wch: 12}, // Stock Quantity
          {wch: 15}, // Barcode
          {wch: 30}  // Barcode Visualization
        ];
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, "Products");
        
        // Generate Excel file
        const fileName = `products_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
      } catch (error) {
        console.error("Error generating Excel:", error);
        alert("Error generating Excel. Please try again.");
      } finally {
        // Remove loading message
        document.body.removeChild(loadingMessage);
      }
    }

    // Helper function to create text-based barcode representation
    function generateTextBarcode(barcode) {
      if (!barcode) return '';
      
      // Create a simple text representation of the barcode
      const segments = [];
      for (let i = 0; i < barcode.length; i++) {
        segments.push('|'); // Vertical bars to represent lines
        segments.push(barcode[i]); // The character
      }
      segments.push('|'); // Closing bar
      
      return segments.join(' ');
    }

    function showPdfOptions() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <h5>Select PDF Content</h5>
          <p>What would you like to include in the PDF?</p>
          <div class="modal-buttons">
            <button class="barcode-only-btn" onclick="exportToPDF(true)">Barcodes</button>
            <button class="all-info-btn" onclick="exportToPDF(false)">All Information</button>
            <button class="cancel-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function exportToPDF(barcodeOnly = false) {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
  
  const loadingMessage = document.createElement('div');
  loadingMessage.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Generating PDF ${barcodeOnly ? 'with barcodes only' : 'with all information'}...</p></div>`;
  loadingMessage.style.position = 'fixed';
  loadingMessage.style.top = '50%';
  loadingMessage.style.left = '50%';
  loadingMessage.style.transform = 'translate(-50%, -50%)';
  loadingMessage.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
  loadingMessage.style.padding = '20px';
  loadingMessage.style.borderRadius = '10px';
  loadingMessage.style.zIndex = '1000';
  loadingMessage.style.boxShadow = '0 0 20px rgba(0,0,0,0.2)';
  document.body.appendChild(loadingMessage);

  try {
    // Get the currently displayed products (sorted/filtered)
    const displayedProducts = getDisplayedProducts();
    
    // Create PDF in landscape mode for more space
    const doc = new jsPDF({
      orientation: 'landscape',
      unit: 'mm'
    });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 10; // mm
    const padding = 5; // mm
    
    // Calculate layout parameters - same for both modes
    const itemsPerRow = 5; // 5 items per row in both modes
    const rowsPerPage = 4; // 4 rows per page in both modes
    const itemWidth = (pageWidth - 2 * margin) / itemsPerRow;
    const itemHeight = (pageHeight - 2 * margin - 15) / rowsPerPage; // 15mm reserved for header
    
    const itemsPerPage = itemsPerRow * rowsPerPage;
    
    // Add title
    // doc.setFontSize(14);
    // doc.text(`Product ${barcodeOnly ? 'Barcodes' : 'Catalog'}`, pageWidth / 2, margin, { align: 'center' });
    // doc.setFontSize(10);
    // doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, margin + 7, { align: 'center' });
    
    let currentItem = 0;
    let currentPage = 0;
    
    while (currentItem < displayedProducts.length) {
      if (currentItem > 0 && currentItem % itemsPerPage === 0) {
        doc.addPage();
        currentPage++;
        
        // Add header to new page
        // doc.setFontSize(14);
        // doc.text(`Product ${barcodeOnly ? 'Barcodes' : 'Catalog'} (cont.)`, pageWidth / 2, margin, { align: 'center' });
        doc.setFontSize(10);
        doc.text(`Page ${currentPage + 1}`, pageWidth / 2, margin + 7, { align: 'center' });
      }
      
      // Calculate current position on page
      const pageRelativeIndex = currentItem % itemsPerPage;
      const row = Math.floor(pageRelativeIndex / itemsPerRow);
      const col = pageRelativeIndex % itemsPerRow;
      
      const x = margin + col * itemWidth;
      const y = margin + 15 + row * itemHeight; // 15mm from top for header
      
      const product = displayedProducts[currentItem];
      
      if (!barcodeOnly) {
        // Product information (smaller font to fit more items)
        doc.setFontSize(7); // Reduced from 8
        doc.setFont('helvetica', 'bold');
        doc.text(product.name.substring(0, 15), x + padding, y); // Reduced from 20 chars
        doc.setFont('helvetica', 'normal');
        doc.text(`prize: ${product.price}`, x + padding, y + 4); // Reduced spacing
        // Removed stock quantity to save space
      }
      
      if (product.barcode) {
        const canvas = document.querySelector(`#barcode-${product.key}`);
        if (canvas) {
          // Create a new canvas with adjusted size
          const barcodeCanvas = document.createElement('canvas');
          barcodeCanvas.width = 150;
          barcodeCanvas.height = 50;
          
          // Generate barcode with smaller size
          JsBarcode(barcodeCanvas, product.barcode, {
            format: "CODE128",
            lineColor: "#000",
            width: 1.2, // Thinner lines (reduced from 1.5)
            height: 25,  // Shorter height (reduced from 30)
            displayValue: false,
            margin: 3    // Reduced from 5
          });
          
          const imgData = barcodeCanvas.toDataURL('image/png');
          
          // Calculate image dimensions
          const imgWidth = itemWidth - 2 * padding; // Same width for both modes
          const imgHeight = 12; // mm (reduced from 15)
          
          // Position the barcode
          const imgX = x + (itemWidth - imgWidth) / 2;
          const imgY = barcodeOnly ? y : y + 6; // Reduced spacing
          
          doc.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
          
          // Add barcode text below (smaller font)
          doc.setFontSize(5); // Reduced from 6
          doc.text(product.barcode, x + itemWidth / 2, imgY + imgHeight + 2, { align: 'center' }); // Reduced spacing
        }
      }
      
      // Draw item border (optional)
      doc.setDrawColor(200, 200, 200);
      doc.rect(x, y - 5, itemWidth, itemHeight - 5, 'S');
      
      currentItem++;
    }
    
    // Save the PDF
    const fileName = barcodeOnly 
      ? `product_barcodes_${new Date().toISOString().slice(0, 10)}.pdf`
      : `product_catalog_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(fileName);
  } catch (error) {
    console.error("Error generating PDF:", error);
    alert("Error generating PDF. Please try again.");
  } finally {
    document.body.removeChild(loadingMessage);
  }
}
    // Add this function to get the currently displayed products
    function getDisplayedProducts() {
      const searchValue = document.getElementById("searchProduct").value.toLowerCase();
      
      // If there's a search term, return filtered products
      if (searchValue) {
        return allProducts.filter(product => 
          product.name.toLowerCase().includes(searchValue) || 
          (product.barcode && product.barcode.toLowerCase().includes(searchValue))
        );
      }
      
      // Otherwise return sorted products
      return sortProducts([...allProducts]);
    }

    function generateAllBarcodes() {
  if (!confirm("This will generate barcodes for products WITHOUT barcodes. Continue?")) {
    return;
  }

  // Show loading spinner
  document.querySelector(".spinner").style.display = "block";

  // Get all products from Firebase
  database.ref("products").once('value').then(snapshot => {
    const updates = {};
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let count = 0;
    
    snapshot.forEach(childSnapshot => {
      const product = childSnapshot.val();
      const key = childSnapshot.key;
      
      // Skip if product already has a barcode
      if (product.barcode && product.barcode.trim() !== '') {
        return;
      }
      
      // Generate new barcode using the new logic
      const firstLetter = product.name.trim().charAt(0).toUpperCase();
      const formattedPrice = product.price.toString().replace(/\D/g, '');
      
      // Generate 3 random unique letters
      let randomLetters = '';
      const usedIndices = new Set();
      while (randomLetters.length < 3) {
        const randomIndex = Math.floor(Math.random() * letters.length);
        if (!usedIndices.has(randomIndex)) {
          usedIndices.add(randomIndex);
          randomLetters += letters.charAt(randomIndex);
        }
      }
      
      const newBarcode = firstLetter + formattedPrice + randomLetters;
      updates[`products/${key}/barcode`] = newBarcode;
      count++;
    });

    if (count === 0) {
      showSuccessMessage("All products already have barcodes. No updates needed.");
      document.getElementById("generateAllBarcodesBtn").style.display = "none";
      return Promise.resolve();
    }

    // Update products in a single operation
    return database.ref().update(updates);
  })
  .then(() => {
    showSuccessMessage("Barcodes generated successfully for products without barcodes!");
    // Hide the button after generation
    document.getElementById("generateAllBarcodesBtn").style.display = "none";
  })
  .catch(error => {
    console.error("Error generating barcodes:", error);
    alert("Error generating barcodes. Please try again.");
  })
  .finally(() => {
    // Hide loading spinner
    document.querySelector(".spinner").style.display = "none";
  });
}
    
    // Update your existing showSuccessMessage to optionally accept a custom message
    function showSuccessMessage(customMessage) {
      const message = document.getElementById("productMessage");
      if (customMessage) {
        message.querySelector('p').innerHTML = `<i class="fa-solid fa-circle-check"></i> ${customMessage}`;
      }
      message.style.display = "block";
      message.style.opacity = 1;
      
      setTimeout(() => {
        message.style.opacity = 0;
        setTimeout(() => {
          message.style.display = "none";
        }, 500);
      }, 3000);
    }



    function downloadDemoFormat() {
  // Create a new workbook
  const wb = XLSX.utils.book_new();
  
  // Sample data for the demo format
  const demoData = [
    ['Product Name', 'Selling Price', 'Purchase Price', 'Stock Quantity'],
    ['Example Product 1', 100, 80, 10],
    ['Example Product 2', 200, 150, 5],
    ['Example Product 3', 50, 40, 20]
  ];
  
  // Convert to worksheet
  const ws = XLSX.utils.aoa_to_sheet(demoData);
  
  // Set column widths
  ws['!cols'] = [
    {wch: 20}, // Product Name
    {wch: 15}, // Selling Price
    {wch: 15}, // Purchase Price
    {wch: 15}  // Stock Quantity
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, "Products");
  
  // Generate Excel file
  XLSX.writeFile(wb, "product_import_demo_format.xlsx");
}

async function importFromExcel(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Show loading spinner
  document.querySelector(".spinner").style.display = "block";
  
  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
    
    // Remove empty rows and header if exists
    const rows = jsonData.filter(row => row.length > 0 && !row.every(cell => cell === null || cell === ""));
    
    // Check if first row is header
    const isFirstRowHeader = rows.length > 0 && 
      (rows[0].some(cell => typeof cell === 'string' && cell.toLowerCase().includes('name')) ||
       rows[0].some(cell => typeof cell === 'string' && cell.toLowerCase().includes('price')));
    
    const dataRows = isFirstRowHeader ? rows.slice(1) : rows;
    
    if (dataRows.length === 0) {
      alert("No valid data found in the Excel file.");
      return;
    }
    
    // Get all existing products first
    const snapshot = await database.ref("products").once('value');
    const existingProducts = snapshot.val() || {};
    const existingProductNames = new Set(
      Object.values(existingProducts).map(p => p.name.toLowerCase().trim())
    );
    
    // Process each row
    let successCount = 0;
    let errorCount = 0;
    let skipCount = 0;
    const errors = [];
    const skipped = [];
    
    for (let i = 0; i < dataRows.length; i++) {
      const row = dataRows[i];
      try {
        // Try to map columns automatically
        let name, price, purchasePrice, stockQuantity;
        
        // Attempt to find columns by content
        if (row.length >= 4) {
          name = String(row[0]).trim();
          price = parseFloat(row[1]);
          purchasePrice = parseFloat(row[2]);
          stockQuantity = parseInt(row[3]);
        } else if (row.length >= 3) {
          name = String(row[0]).trim();
          price = parseFloat(row[1]);
          purchasePrice = parseFloat(row[2]);
          stockQuantity = row.length > 3 ? parseInt(row[3]) : 0;
        } else if (row.length >= 2) {
          name = String(row[0]).trim();
          price = parseFloat(row[1]);
          purchasePrice = 0;
          stockQuantity = 0;
        } else {
          throw new Error("Insufficient data in row");
        }
        
        // Validate required fields
        if (!name || isNaN(price)) {
          throw new Error("Missing required fields (name and price)");
        }
        
        // Check if product already exists
        if (existingProductNames.has(name.toLowerCase())) {
          skipCount++;
          skipped.push(`Row ${i + (isFirstRowHeader ? 2 : 1)}: "${name}" already exists`);
          continue;
        }
        
        // Set defaults if not provided
        if (isNaN(purchasePrice)) purchasePrice = 0;
        if (isNaN(stockQuantity)) stockQuantity = 0;
        
        // Calculate profit
        const profit = price - purchasePrice;
        
        // Create product in database
        await database.ref("products").push().set({
          name,
          price,
          purchasePrice,
          stockQuantity,
          profit,
          barcode: ""
        });
        
        // Add to existing names to prevent duplicates in the same import
        existingProductNames.add(name.toLowerCase());
        successCount++;
        
      } catch (error) {
        errorCount++;
        errors.push(`Row ${i + (isFirstRowHeader ? 2 : 1)}: ${error.message}`);
      }
    }
    
    // Show results
    let resultMessage = `Import completed: ${successCount} products added successfully.`;
    if (skipCount > 0) {
      resultMessage += ` ${skipCount} products skipped (already exist).`;
      console.log("Skipped products:", skipped.join("\n"));
    }
    if (errorCount > 0) {
      resultMessage += ` ${errorCount} rows had errors.`;
      console.error("Import errors:", errors.join("\n"));
    }
    
    showSuccessMessage(resultMessage);
    sortAndDisplayProducts();
    
    // Clear file input
    event.target.value = '';
    
  } catch (error) {
    console.error("Error importing Excel:", error);
    alert("Error importing Excel file. Please check the format and try again.");
  } finally {
    // Hide loading spinner
    document.querySelector(".spinner").style.display = "none";
  }
}

async function downloadBarcodeImages() {
  // Show loading spinner
  document.querySelector(".spinner").style.display = "block";
  
  try {
    const zip = new JSZip();
    const barcodeFolder = zip.folder("product_barcodes");
    const displayedProducts = getDisplayedProducts();
    
    // Process each product
    for (const product of displayedProducts) {
      if (!product.barcode) continue;
      
      // Create a canvas for the complete label
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas dimensions (width: 3 inches, height: 1.5 inches at 150 DPI)
      canvas.width = 350;
      canvas.height = 175;
      
      // Draw white background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw border
      ctx.strokeStyle = '#ddd';
      ctx.strokeRect(0, 0, canvas.width, canvas.height);
      
      // Product Information
      ctx.fillStyle = 'black';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(product.name, canvas.width / 2, 30);

      ctx.font = 'bold 20px Arial';
      ctx.fillText(`Price: â‚¹${product.price}`, canvas.width / 2, 60);

      // Barcode Section
      const barcodeCanvas = document.createElement('canvas');
      barcodeCanvas.width = canvas.width * 0.8;
      barcodeCanvas.height = 100;

      // Generate barcode
      JsBarcode(barcodeCanvas, product.barcode, {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 60,
        displayValue: true,
        fontSize: 16,
        margin: 5
      });

      // Position barcode
      const barcodeX = (canvas.width - barcodeCanvas.width) / 2;
      const barcodeY = 80;
      ctx.drawImage(barcodeCanvas, barcodeX, barcodeY);
      
      // Convert canvas to image data
      const imageData = canvas.toDataURL('image/png').split(',')[1];
      
      // Create filename with product details
      const cleanName = product.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
      const filename = `${cleanName}_â‚¹${product.price}_${product.barcode}.png`;
      
      // Add to zip
      barcodeFolder.file(filename, imageData, {base64: true});
    }
    
    // Generate zip file
    const content = await zip.generateAsync({type: 'blob'});
    saveAs(content, `product_labels_${new Date().toISOString().slice(0, 10)}.zip`);
    
  } catch (error) {
    console.error("Error generating barcode images:", error);
    alert("Error generating barcode images. Please try again.");
  } finally {
    // Hide loading spinner
    document.querySelector(".spinner").style.display = "none";
  }
}

function downloadSingleBarcode(key, name, price, barcode) {
  if (!barcode) {
    alert("This product doesn't have a barcode yet!");
    return;
  }

  // Create a canvas for the label
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas dimensions
  canvas.width = 350;
  canvas.height = 175;

  // Draw black border
  ctx.lineWidth = 8; // Border thickness
  ctx.strokeStyle = '#000000'; // Explicit deep black
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
  
  // Draw white background
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Draw border
  ctx.strokeStyle = '#ddd';
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
  
  // Product Information
  ctx.fillStyle = 'black';
  ctx.font = 'bold 24px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(name, canvas.width / 2, 30);

  ctx.font = 'bold 20px Arial';
  ctx.fillText(`Price: â‚¹${price}`, canvas.width / 2, 60);

  // Barcode Section
  const barcodeCanvas = document.createElement('canvas');
  barcodeCanvas.width = canvas.width * 0.8;
  barcodeCanvas.height = 100;

  // Generate barcode
  JsBarcode(barcodeCanvas, barcode, {
    format: "CODE128",
    lineColor: "#000",
    width: 2,
    height: 60,
    displayValue: true,
    fontSize: 16,
    margin: 5
  });

  // Position barcode
  const barcodeX = (canvas.width - barcodeCanvas.width) / 2;
  const barcodeY = 80;
  ctx.drawImage(barcodeCanvas, barcodeX, barcodeY);

  // Convert to image and download
  const imageData = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = imageData;
  link.download = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_â‚¹${price}_${barcode}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}






// Initialize the toggle button
function initAveragePriceToggle() {
  database.ref("CalculateAverageForPurchasePrice").on('value', (snapshot) => {
    const shouldCalculate = snapshot.val();
    document.getElementById("averagePriceToggle").checked = shouldCalculate === true;
  });
  
  // Add event listener for toggle changes
  document.getElementById("averagePriceToggle").addEventListener('change', (e) => {
    const newValue = e.target.checked;
    database.ref("CalculateAverageForPurchasePrice").set(newValue)
      .then(() => {
        showToastMessage(`Calculate Average For PurchasePrice: ${newValue ? 'ON' : 'OFF'}`);
      })
      .catch((error) => {
        console.error("Error updating setting:", error);
        showToastMessage("Error updating setting", true);
      });
  });
}

// Call this when your app loads
initAveragePriceToggle();

// Helper function for notifications
function showToastMessage(message, isError = false) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.padding = '10px 20px';
  toast.style.backgroundColor = isError ? '#ff4444' : '#4CAF50';
  toast.style.color = 'white';
  toast.style.borderRadius = '4px';
  toast.style.zIndex = '1000';
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}



function showPrintModal(key, name, price, barcode) {
  if (!barcode) {
    alert("This product doesn't have a barcode yet!");
    return;
  }

  // Clear previous content
  const printPreview = document.getElementById('printPreview');
  printPreview.innerHTML = '';
  
  // Clone the template
  const template = document.getElementById('printTemplate');
  const clone = template.cloneNode(true);
  clone.id = 'printClone';
  clone.style.display = 'block';
  
  // Set product info - fixed to match your HTML structure
  const productNameElement = clone.querySelector('#printProductName');
  // Design 1
  //productNameElement.innerHTML = `${name},<span id="printProductPrice"> â‚¹${price}`;

  //  Design 2
  productNameElement.innerHTML = `${name}<br>Price:<span id="printProductPrice"> â‚¹${price}`;
  
  // Create canvas for barcode
  const canvas = document.createElement('canvas');

  // Set high resolution for HD quality
  canvas.width = 400;
  canvas.height = 100;

  clone.querySelector('#printBarcodeContainer').appendChild(canvas);

  // Generate barcode with print-optimized settings
  JsBarcode(canvas, barcode, {
    format: "CODE128",
    lineColor: "#000",
    width: 1.5,
    height: 38,
    displayValue: false,
    fontSize: 16,
    margin: 0,
  });
  
   // Set barcode text manually
   const barcodeTextElement = clone.querySelector('#printBarcodeText');
  if (barcodeTextElement) {
    barcodeTextElement.textContent = barcode;
  }
  // Add to preview
  printPreview.appendChild(clone);
  
  // Show the modal
  $('#printModal').modal('show');
}


// function downloadBarcodeImage() {
//   // Get the preview container
//   const preview = document.getElementById('printPreview');
//   const clone = preview.querySelector('#printClone');
  
//   if (!clone) return;
  
//   // Get product details from the DOM
//   const nameElement = clone.querySelector('#printProductName');
//   const priceElement = clone.querySelector('#printProductPrice');
  
//   // Extract text content and clean it up
//   const name = nameElement ? nameElement.textContent.split(',')[0].trim() : 'product';
//   const price = priceElement ? priceElement.textContent.replace('â‚¹', '').trim() : '0';
  
//   // Create a canvas for the complete label
//   const canvas = document.createElement('canvas');
//   const ctx = canvas.getContext('2d');
  
//   // Set canvas dimensions (slightly larger for better quality)
//   canvas.width = clone.offsetWidth * 2;
//   canvas.height = clone.offsetHeight * 2;
  
//   // Draw white background
//   ctx.fillStyle = 'white';
//   ctx.fillRect(0, 0, canvas.width, canvas.height);
  
//   // Draw the preview content
//   html2canvas(clone, {
//     scale: 2,
//     backgroundColor: null,
//     canvas: canvas,
//     logging: false
//   }).then(canvas => {
//     // Convert to image and download
//     const imageData = canvas.toDataURL('image/png');
//     const link = document.createElement('a');
    
//     // Create filename (clean special characters)
//     const cleanName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
//     link.href = imageData;
//     link.download = `${cleanName}_â‚¹${price}_sticker.png`;
//     document.body.appendChild(link);
//     link.click();
//     document.body.removeChild(link);
    
//     // Close the modal
//     $('#printModal').modal('hide');
//   });
// }

    function downloadBarcodeImage() {
  const preview = document.getElementById('printPreview');
  const clone = preview.querySelector('#printClone');
  if (!clone) return;

  const nameElement = clone.querySelector('#printProductName');
  const priceElement = clone.querySelector('#printProductPrice');

  const name = nameElement ? nameElement.textContent.split(',')[0].trim() : 'product';
  const price = priceElement ? priceElement.textContent.replace('â‚¹', '').trim() : '0';

  // Temporarily scale the element up for higher resolution
  //clone.style.transform = 'scale(2)';
  clone.style.transformOrigin = 'top left';
  clone.style.width = '2.5in';
  clone.style.hight = '1.5in';


  html2canvas(clone, {
    scale: 2,  // Ensures high-quality image
    useCORS: true
  }).then(canvas => {
    // Reset transform
    clone.style.transform = '';
    clone.style.transformOrigin = '';

    const imageData = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    const cleanName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();

    link.href = imageData;
    link.download = `${cleanName}_â‚¹${price}_sticker.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    $('#printModal').modal('hide');
  });
}

  </script>
  
</body>
</html>
