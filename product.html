<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Products</title>
  <link rel="icon" type="image/png" href="img/logotab.png">
  <link href="css/bg.css" rel="stylesheet">
  <script src="css/all.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Add JsBarcode library -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- Add jsPDF and html2canvas libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <style>
    .spinner {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .barcode-container {
      margin-top: 10px;
      text-align: center;
    }
    .barcode {
      height: 50px;
      max-width: 100%;
    }
    .barcode-label {
      font-size: 12px;
      margin-top: 5px;
    }
    .product-barcode {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .export-buttons {
      display: flex;
      gap: 10px;
    }
     /* Previous styles remain the same */
     .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      text-align: center;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .barcode-only-btn {
      background-color: #4CAF50;
      color: white;
    }
    .all-info-btn {
      background-color: #2196F3;
      color: white;
    }
    .cancel-btn {
      background-color: #f44336;
      color: white;
    }
    .sort-btn {
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div>
    <div class="particles" id="particles"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>
  <!-- Image and text -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow">
    <div class="container d-flex justify-content-between align-items-center">
      
      <!-- Back Button -->
      <a class="navbar-brand d-flex align-items-center" href="index.html" style="padding: 8px 12px; border-radius: 50%; background-color: #17a2b8;">
        <i class="fas fa-arrow-left text-white"></i>
      </a>
  
      <!-- Logout Button -->
      <button class="btn btn-outline-light btn-sm" onclick="logout()" title="Logout">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>
  <div class="container mt-5" style="padding-top: 20px;">
    <div id="productMessage">
      <p class="indi"> <i class="fa-solid fa-circle-check"></i> Success</p>
    </div>
    <div class="row mb-1">
      <div class="col-md-4">
        <input type="text" id="searchProduct" class="form-control mb-1" placeholder="Search Products" onkeyup="searchProducts()">
      </div>
      <div class="col-md-2">
        <input type="text" id="productName" class="form-control mb-1" placeholder="Product Name" autocomplete="off">
      </div>
      <div class="col-md-2">
        <input type="number" id="productPrice" class="form-control mb-1" placeholder="Product Price" autocomplete="off">
      </div>
      <div class="col-md-2">
        <input type="text" id="productBarcode" class="form-control mb-1" placeholder="Barcode (auto)" autocomplete="off">
      </div>
      <div class="col-md-2">
        <button id="addProductBtn" class="btn btn2 text-light mb-1 w-100" onclick="addOrUpdateProduct()"> <i class="fas fa-plus-circle"></i> Add</button>
      </div>
    </div>
    <!-- Product Count & Export Button -->
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div>
        <p class="bg-light p-2 rounded border d-inline-block">Total Products: <span id="productCount">0</span></p>
        <span id="sortButton" class="sort-btn" title="Sort by name" onclick="toggleSort()">
          <i class="fas fa-sort-alpha-down"></i>
        </span>
      </div>
      <div class="export-buttons">
        <button id="generateAllBarcodesBtn" class="btn btn-info" onclick="generateAllBarcodes()">
          <i class="fas fa-barcode"></i> Generate All
        </button>
        <button id="exportExcelBtn" class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
        <button id="exportPdfBtn" class="btn btn-danger" onclick="showPdfOptions()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- Product List -->
    <ul id="productList" class="list-group"></ul>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    let editingProductKey = null;
    let allProducts = [];
    let sortDirection = 'asc'; // 'asc' or 'desc'

    function toggleSort() {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      updateSortButtonIcon();
      sortAndDisplayProducts();
    }

    function updateSortButtonIcon() {
      const sortButton = document.getElementById('sortButton');
      if (sortDirection === 'asc') {
        sortButton.innerHTML = '<i class="fas fa-sort-alpha-down"></i>';
        sortButton.title = "Sort by name (A-Z)";
      } else {
        sortButton.innerHTML = '<i class="fas fa-sort-alpha-up"></i>';
        sortButton.title = "Sort by name (Z-A)";
      }
    }

    function sortProducts(products) {
      return products.sort((a, b) => {
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        if (sortDirection === 'asc') {
          return nameA.localeCompare(nameB);
        } else {
          return nameB.localeCompare(nameA);
        }
      });
    }

    function sortAndDisplayProducts() {
      const sortedProducts = sortProducts([...allProducts]);
      displayProducts(sortedProducts);
    }

    // Updated generateBarcode function to create barcode in the format "K250URTIS"
    function generateBarcode(name, price) {
  // Get first letter of name (uppercase)
  let firstLetter = name.trim().charAt(0).toUpperCase();
  
  // Format price (remove non-numeric characters)
  let formattedPrice = price.toString().replace(/\D/g, '');
  
  // Generate 3 random unique letters (uppercase)
  let randomLetters = '';
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const usedIndices = new Set();
  
  while (randomLetters.length < 3) {
    const randomIndex = Math.floor(Math.random() * letters.length);
    if (!usedIndices.has(randomIndex)) {
      usedIndices.add(randomIndex);
      randomLetters += letters.charAt(randomIndex);
    }
  }
  
  // Combine all parts
  let formattedBarcode = firstLetter + formattedPrice + randomLetters;
  
  document.getElementById("productBarcode").value = formattedBarcode;
}

    function addOrUpdateProduct() {
      let name = document.getElementById("productName").value;
      let price = document.getElementById("productPrice").value;
      let barcode = document.getElementById("productBarcode").value;
      
      if (name && price) {
        if (!barcode) {
          generateBarcode(name, price);
          barcode = document.getElementById("productBarcode").value;
        }
        
        if (editingProductKey) {
          database.ref("products/" + editingProductKey).update({ name, price, barcode })
            .then(() => {
              showSuccessMessage();
              editingProductKey = null;
              document.getElementById("addProductBtn").innerHTML = '<i class="fas fa-plus-circle"></i> Add';
            });
        } else {
          let newProduct = database.ref("products").push();
          newProduct.set({ name, price, barcode })
            .then(() => {
              showSuccessMessage();
            });
        }
        document.getElementById("productName").value = "";
        document.getElementById("productPrice").value = "";
        document.getElementById("productBarcode").value = "";
      }
    }

    function fetchProducts() {
      document.querySelector(".spinner").style.display = "block";

      database.ref("products").on("value", snapshot => {
        document.querySelector(".spinner").style.display = "none";
        allProducts = [];
        snapshot.forEach(childSnapshot => {
          let product = childSnapshot.val();
          product.key = childSnapshot.key;
          allProducts.push(product);
        });
        sortAndDisplayProducts();
      });
    }

    function displayProducts(products) {
      let productList = document.getElementById("productList");
      productList.innerHTML = "";
      document.getElementById("productCount").innerText = products.length;
      
      products.forEach(product => {
        let barcodeCanvasId = `barcode-${product.key}`;
        let barcodeContainer = `
          <div class="product-barcode">
            <canvas id="${barcodeCanvasId}" class="barcode"></canvas>
            <div class="barcode-label">${product.barcode || 'No barcode'}</div>
          </div>
        `;
        
        let productItem = `
          <li class="glass mb-2 d-flex justify-content-between align-items-center">
            <div>
              <strong>${product.name}</strong><br>
              <span>Price: ₹${product.price}</span>
            </div>
            <div class="d-flex align-items-center">
              ${barcodeContainer}
              <div class="ml-3">
                <button class="btn btn-warning btn-sm mr-2" onclick="editProduct('${product.key}', '${product.name}', '${product.price}', '${product.barcode || ''}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.key}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </li>
        `;
        productList.innerHTML += productItem;
        
        if (product.barcode) {
          setTimeout(() => {
            JsBarcode(`#${barcodeCanvasId}`, product.barcode, {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 50,
            displayValue: false
          });
          }, 100);
        }
      });
    }

    function searchProducts() {
      let searchValue = document.getElementById("searchProduct").value.toLowerCase();
      let filteredProducts = allProducts.filter(product => 
        product.name.toLowerCase().includes(searchValue) || 
        (product.barcode && product.barcode.toLowerCase().includes(searchValue))
      );
      displayProducts(filteredProducts);
    }

    function editProduct(key, name, price, barcode) {
      document.getElementById("productName").value = name;
      document.getElementById("productPrice").value = price;
      document.getElementById("productBarcode").value = barcode;
      editingProductKey = key;
      document.getElementById("addProductBtn").innerHTML = '<i class="fas fa-save"></i> Save';
      document.querySelector('.row.mb-1').scrollIntoView({ behavior: 'smooth', block: 'start' });
      document.getElementById("productName").focus();
    }

    function deleteProduct(key) {
      if (confirm("Are you sure you want to delete this product?")) {
        database.ref("products/" + key).remove()
          .then(() => {
            showSuccessMessage();
          })
          .catch((error) => {
            console.error("Error deleting product: ", error);
          });
      }
    }

    function showSuccessMessage() {
      const message = document.getElementById("productMessage");
      message.style.display = "block";
      message.style.opacity = 1;
      
      setTimeout(() => {
        message.style.opacity = 0;
        setTimeout(() => {
          message.style.display = "none";
        }, 500);
      }, 3000);
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        fetchProducts();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Auto-generate barcode when name or price changes
      document.getElementById("productName").addEventListener('input', function() {
        if (!editingProductKey) { // Only auto-generate when adding new products
          let name = this.value;
          let price = document.getElementById("productPrice").value;
          if (name && price) {
            generateBarcode(name, price);
          }
        }
      });

      document.getElementById("productPrice").addEventListener('input', function() {
        if (!editingProductKey) { // Only auto-generate when adding new products
          let price = this.value;
          let name = document.getElementById("productName").value;
          if (name && price) {
            generateBarcode(name, price);
          }
        }
      });

      document.getElementById("productBarcode").addEventListener('click', function() {
        let name = document.getElementById("productName").value;
        let price = document.getElementById("productPrice").value;
        if (!this.value && name && price) {
          generateBarcode(name, price);
        }
      });
    });

    async function exportToExcel() {
  // Show loading message
  const loadingMessage = document.createElement('div');
  loadingMessage.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Generating Excel file...</p></div>';
  document.body.appendChild(loadingMessage);

  try {
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Prepare the data with barcode visualization
    const excelData = allProducts.map(product => ({
      'Product Name': product.name,
      'Price': `₹${product.price}`,
      'Barcode': product.barcode || '',
      'Barcode Visualization': generateTextBarcode(product.barcode)
    }));
    
    // Convert to worksheet
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // Set column widths
    ws['!cols'] = [
      {wch: 20}, // Product Name
      {wch: 10}, // Price
      {wch: 15}, // Barcode
      {wch: 30}  // Barcode Visualization
    ];
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, "Products");
    
    // Generate Excel file
    const fileName = `products_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
  } catch (error) {
    console.error("Error generating Excel:", error);
    alert("Error generating Excel. Please try again.");
  } finally {
    // Remove loading message
    document.body.removeChild(loadingMessage);
  }
}

// Helper function to create text-based barcode representation
function generateTextBarcode(barcode) {
  if (!barcode) return '';
  
  // Create a simple text representation of the barcode
  const segments = [];
  for (let i = 0; i < barcode.length; i++) {
    segments.push('|'); // Vertical bars to represent lines
    segments.push(barcode[i]); // The character
  }
  segments.push('|'); // Closing bar
  
  return segments.join(' ');
}
    function showPdfOptions() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <h5>Select PDF Content</h5>
          <p>What would you like to include in the PDF?</p>
          <div class="modal-buttons">
            <button class="barcode-only-btn" onclick="exportToPDF(true)">Barcodes</button>
            <button class="all-info-btn" onclick="exportToPDF(false)">All Information</button>
            <button class="cancel-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function exportToPDF(barcodeOnly = false) {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
  
  const loadingMessage = document.createElement('div');
  loadingMessage.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2">Generating PDF ${barcodeOnly ? 'with barcodes only' : 'with all information'}...</p></div>`;
  loadingMessage.style.position = 'fixed';
  loadingMessage.style.top = '50%';
  loadingMessage.style.left = '50%';
  loadingMessage.style.transform = 'translate(-50%, -50%)';
  loadingMessage.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
  loadingMessage.style.padding = '20px';
  loadingMessage.style.borderRadius = '10px';
  loadingMessage.style.zIndex = '1000';
  loadingMessage.style.boxShadow = '0 0 20px rgba(0,0,0,0.2)';
  document.body.appendChild(loadingMessage);

  try {
    // Get the currently displayed products (sorted/filtered)
    const displayedProducts = getDisplayedProducts();
    
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    const columns = barcodeOnly ? 4 : 3;
    const columnWidth = (pageWidth - margin * 2) / columns;
    
    // Calculate available height per page
    const pageHeight = doc.internal.pageSize.getHeight();
    let yPosition = 35; // Start below header
    const itemHeight = barcodeOnly ? 40 : 60;
    const maxItemsPerPage = Math.floor((pageHeight - yPosition) / itemHeight) * columns;
    
    // Add title
    doc.setFontSize(18);
    doc.text(`Product ${barcodeOnly ? 'Barcodes' : 'Catalog'}`, pageWidth / 2, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 25, { align: 'center' });
    
    let currentItem = 0;
    
    // Process products in batches that fit perfectly on each page
    while (currentItem < displayedProducts.length) {
      // Calculate how many items can fit on current page
      const itemsRemaining = displayedProducts.length - currentItem;
      const itemsThisPage = Math.min(maxItemsPerPage, itemsRemaining);
      
      // Process items for this page
      for (let i = 0; i < itemsThisPage; i++) {
        const product = displayedProducts[currentItem + i];
        const column = i % columns;
        const row = Math.floor(i / columns);
        
        const xPosition = margin + column * columnWidth;
        const currentY = yPosition + row * itemHeight;
        
        if (!barcodeOnly) {
          doc.setFontSize(10);
          doc.text(product.name, xPosition + 5, currentY);
          doc.text(`Price: ₹${product.price}`, xPosition + 5, currentY + 5);
        }
        
        if (product.barcode) {
          const canvas = document.querySelector(`#barcode-${product.key}`);
          if (canvas) {
            const canvasImage = await html2canvas(canvas);
            const imgData = canvasImage.toDataURL('image/png');
            
            const imgWidth = barcodeOnly ? columnWidth - 10 : columnWidth - 10;
            const imgHeight = barcodeOnly ? 20 : 20;
            const imgY = barcodeOnly ? currentY : currentY + 10;
            
            doc.addImage(imgData, 'PNG', xPosition, imgY, imgWidth, imgHeight);
            
            doc.setFontSize(8);
            const textY = barcodeOnly ? currentY + 25 : currentY + 35;
            doc.text(product.barcode, xPosition + imgWidth / 2, textY, { align: 'center' });
          }
        }
      }
      
      currentItem += itemsThisPage;
      
      // Add new page if there are more products
      if (currentItem < displayedProducts.length) {
        doc.addPage();
        yPosition = 20; // Reset Y position for new page
        
        // Add header to new page
        doc.setFontSize(18);
        doc.text(`Product ${barcodeOnly ? 'Barcodes' : 'Catalog'} (cont.)`, pageWidth / 2, 15, { align: 'center' });
      }
    }
    
    // Save the PDF
    const fileName = barcodeOnly 
      ? `product_barcodes_${new Date().toISOString().slice(0, 10)}.pdf`
      : `product_catalog_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(fileName);
  } catch (error) {
    console.error("Error generating PDF:", error);
    alert("Error generating PDF. Please try again.");
  } finally {
    document.body.removeChild(loadingMessage);
  }
}

// Add this function to get the currently displayed products
function getDisplayedProducts() {
  const searchValue = document.getElementById("searchProduct").value.toLowerCase();
  
  // If there's a search term, return filtered products
  if (searchValue) {
    return allProducts.filter(product => 
      product.name.toLowerCase().includes(searchValue) || 
      (product.barcode && product.barcode.toLowerCase().includes(searchValue))
    );
  }
  
  // Otherwise return sorted products
  return sortProducts([...allProducts]);
}
  </script>

<script>
  function generateAllBarcodes() {
    if (!confirm("This will update barcodes for ALL products. Continue?")) {
      return;
    }
  
    // Show loading spinner
    document.querySelector(".spinner").style.display = "block";
  
    // Get all products from Firebase
    database.ref("products").once('value').then(snapshot => {
      const updates = {};
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      
      snapshot.forEach(childSnapshot => {
        const product = childSnapshot.val();
        const key = childSnapshot.key;
        
        // Generate new barcode using the new logic
        const firstLetter = product.name.trim().charAt(0).toUpperCase();
        const formattedPrice = product.price.toString().replace(/\D/g, '');
        
        // Generate 3 random unique letters
        let randomLetters = '';
        const usedIndices = new Set();
        while (randomLetters.length < 3) {
          const randomIndex = Math.floor(Math.random() * letters.length);
          if (!usedIndices.has(randomIndex)) {
            usedIndices.add(randomIndex);
            randomLetters += letters.charAt(randomIndex);
          }
        }
        
        const newBarcode = firstLetter + formattedPrice + randomLetters;
        updates[`products/${key}/barcode`] = newBarcode;
      });
  
      // Update all products in a single operation
      return database.ref().update(updates);
    })
    .then(() => {
      showSuccessMessage("All barcodes updated successfully!");
    })
    .catch(error => {
      console.error("Error updating barcodes:", error);
      alert("Error updating barcodes. Please try again.");
    })
    .finally(() => {
      // Hide loading spinner
      document.querySelector(".spinner").style.display = "none";
    });
  }
  
  // Update your existing showSuccessMessage to optionally accept a custom message
  function showSuccessMessage(customMessage) {
    const message = document.getElementById("productMessage");
    if (customMessage) {
      message.querySelector('p').innerHTML = `<i class="fa-solid fa-circle-check"></i> ${customMessage}`;
    }
    message.style.display = "block";
    message.style.opacity = 1;
    
    setTimeout(() => {
      message.style.opacity = 0;
      setTimeout(() => {
        message.style.display = "none";
      }, 500);
    }, 3000);
  }
  </script>
</body>
</html>